<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    

    <!--Author-->
    
        <meta name="author" content="JoralmoPro">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="JoralmoPro">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="JoralmoPro">

    <!--Type page-->
    
        <meta property="og:type" content="website">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>JoralmoPro</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Inicio
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Posts
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/acercade">
                    Acerca de
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-terminal" aria-hidden="true"></i></a>
        
            <h1 id="main-title" class="title">JoralmoPro</h1>
        
    </div>
</header>

        <section class="main">
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2019/04/11/Autenticacion-y-manejo-de-roles-con-RubyOnRails/">
                Autenticación y manejo de roles con RubyOnRails
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-04-11</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="Como-dice-en-el-titulo-del-post-tratare-de-hacer-un-tutorial-de-como-implementar-un-sistema-autenticacion-y-de-roles-utilizando-ROR-para-esto-creare-un-proyecto-en-el-que-hay-usuarios-de-3-tipos-administrador-usuario-visitante-y-cada-usuario-tiene-posts-y-sera-una-pequena-API-por-lo-que-no-tendra-nada-en-el-front-para-la-autenticacion-utilizare-el-estandar-JWT-Json-Web-Token-con-la-gema-ruby-jwt-y-para-el-manejo-de-roles-una-libreria-de-autorizacion-que-es-la-gema-cancancan"><a href="#Como-dice-en-el-titulo-del-post-tratare-de-hacer-un-tutorial-de-como-implementar-un-sistema-autenticacion-y-de-roles-utilizando-ROR-para-esto-creare-un-proyecto-en-el-que-hay-usuarios-de-3-tipos-administrador-usuario-visitante-y-cada-usuario-tiene-posts-y-sera-una-pequena-API-por-lo-que-no-tendra-nada-en-el-front-para-la-autenticacion-utilizare-el-estandar-JWT-Json-Web-Token-con-la-gema-ruby-jwt-y-para-el-manejo-de-roles-una-libreria-de-autorizacion-que-es-la-gema-cancancan" class="headerlink" title="Como dice en el titulo del post trataré de hacer un tutorial de como implementar un sistema autenticación y de roles utilizando ROR, para esto crearé un proyecto en el que hay usuarios de 3 tipos (administrador, usuario, visitante) y cada usuario tiene posts y será una pequeña API por lo que no tendrá nada en el front, para la autenticación utilizaré el estandar JWT (Json Web Token) con la gema ruby-jwt, y para el manejo de roles una librería de autorización que es la gema cancancan."></a>Como dice en el titulo del post trataré de hacer un tutorial de como implementar un sistema autenticación y de roles utilizando ROR, para esto crearé un proyecto en el que hay usuarios de 3 tipos (administrador, usuario, visitante) y cada usuario tiene posts y será una pequeña API por lo que no tendrá nada en el front, para la autenticación utilizaré el estandar JWT (Json Web Token) con la gema <a href="https://github.com/jwt/ruby-jwt" target="_blank" rel="noopener">ruby-jwt</a>, y para el manejo de roles una librería de autorización que es la gema <a href="https://github.com/CanCanCommunity/cancancan/" target="_blank" rel="noopener">cancancan</a>.</h4><p>Y bueno empecemos, asumo que tienes rails y ruby instalado en tu pc, para este tutorial he utilizado las versiones:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ruby -v</span><br><span class="line">&gt; ruby 2.6.1p33 (2019-01-30 revision 66950) [x86_64-linux]</span><br><span class="line">$ rails -v</span><br><span class="line">&gt; Rails 5.2.3</span><br></pre></td></tr></table></figure>
<p>Lo primero que debemos hacer es crear el proyecto con <code>rails new authTutorial</code></p>
<p>Siguiente a esto creamos los modelos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rails g model Rol nombre:string</span><br><span class="line">rails g model Usuario correo:string password_digest:string rol:references</span><br><span class="line">rails g model Post titulo:string contenido:string usuario:references</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Importante el atributo password_digest que es el que le indica a rails que debe encriptar la contraseña al momento del registro.</p>
</blockquote>
<blockquote>
<p>Importante crearlos en este orden para que no haya problemas al momento de migrar la base de datos.</p>
</blockquote>
<p>Los anteriores comandos nos generarán tres modelos y tres migraciones.</p>
<p>Ahora debemos ir al modelo de usuarios en app/models/usuario.rb y decirle a rails que es un modelo al cual le debe encriptar la contraseña agregandole has_secure_password</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Usuario</span> &lt; ApplicationRecord</span></span><br><span class="line">  has_secure_password</span><br><span class="line">  belongs_to <span class="symbol">:rol</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>El <code>belogns_to</code> se agrega automaticamente al momento de crear el modelo con el generador</p>
<p>Lo que haremos ahora será configurar nuestra base de datos en /config/database.yml en el cual para este tutorial yo utilizaré la gema mysql2, por lo tanto en el Gemfile reemplazaré sqlite3 por mysql2</p>
<p>database.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default:</span> <span class="meta">&amp;default</span></span><br><span class="line"><span class="attr">  adapter:</span> <span class="string">mysql2</span></span><br><span class="line"><span class="attr">  pool:</span> &lt;%=<span class="ruby"> ENV.fetch(<span class="string">"RAILS_MAX_THREADS"</span>) &#123; <span class="number">5</span> &#125; </span>%&gt;</span><br><span class="line"><span class="attr">  timeout:</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*default</span></span><br><span class="line"><span class="attr">  database:</span> <span class="string">authTutorial</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">tutorial</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">JoralmoPro</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*default</span></span><br><span class="line">  <span class="comment">#database: db/test.sqlite3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">production:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*default</span></span><br><span class="line">  <span class="comment">#database: db/production.sqlite3</span></span><br></pre></td></tr></table></figure>
<p>Una vez terminado con este archivo, pasamos al seed (ahora explico porque he comentado las bases de datos de los otros dos enviroments).</p>
<p>En el seed vamos a crear unos cuantos datos para la base de datos, utilizaré faker para estó, por lo tanto en el Gemfile toca agregar <code>gem&#39;faker&#39;</code> por lo menos yo lo he agregado solamente para el grupo de development y test, adicionalmente descomentar <code>gem &#39;bcrypt&#39;</code> para la contraseña del usuario, luego hacemos <code>bundle install</code></p>
<p>Una vez agregada la gema vamos al archivo db/seeds.rb</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">administrador = Rol.create(<span class="symbol">nombre:</span> <span class="string">"administrador"</span>)</span><br><span class="line">cliente = Rol.create(<span class="symbol">nombre:</span> <span class="string">"cliente"</span>)</span><br><span class="line">visitante = Rol.create(<span class="symbol">nombre:</span> <span class="string">"visitante"</span>)</span><br><span class="line"></span><br><span class="line">Usuario.create(<span class="symbol">correo:</span> <span class="string">"joralmopro@gmail.com"</span>, <span class="symbol">password:</span> <span class="string">"123456"</span>, <span class="symbol">rol:</span> administrador)</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>.times <span class="keyword">do</span></span><br><span class="line">    usuario = Usuario.create(<span class="symbol">correo:</span> Faker::Internet.email, <span class="symbol">password:</span> <span class="string">"cliente"</span>, <span class="symbol">rol:</span> cliente)</span><br><span class="line">    Post.create(<span class="symbol">titulo:</span> Faker::Book.title, <span class="symbol">contenido:</span> Faker::Lorem.paragraph, <span class="symbol">usuario:</span> usuario)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">p <span class="string">"<span class="subst">#&#123;Usuario.count&#125;</span> usuarios creados"</span></span><br><span class="line">p <span class="string">"<span class="subst">#&#123;Rol.count&#125;</span> roles creados"</span></span><br><span class="line">p <span class="string">"<span class="subst">#&#123;Post.count&#125;</span> post creados"</span></span><br></pre></td></tr></table></figure>
<p>Esto creará los tres roles mencionados al principio, un usuario administrador y 5 usuarios normales y al final nos mostrará en consola cuantas entidades a creado de cada modelo.</p>
<p>Teniendo ya esto listo procedemos a ejecutar en la consola</p>
<p><code>rails db:create; and rails db:migrate; and rails db:seed</code> <strong>(Yo uso fish en ubuntu, si usas bash normal reemplazar los ; and por &amp;&amp;)</strong></p>
<p>El anterior comando es el motivo por el que he comentado las bases de datos de los otros dos enviromentes pues al hacer db:create intentará crear las bases de datos y dará error pues no tengo sqlite3, en caso de necesitarlas solo escribes en consola <code>rails db:environment:set RAILS_ENV=development</code> para que siempre utilice el enviroment development.</p>
<p>Despues de ejecutar el comando anterior deberas ver algo como esto en la consola</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Created database <span class="string">'authTutorial'</span></span><br><span class="line">== 20190411210050 CreateRols: migrating =======================================</span><br><span class="line">-- create_table(:rols)</span><br><span class="line">   -&gt; 0.2598s</span><br><span class="line">== 20190411210050 CreateRols: migrated (0.2599s) ==============================</span><br><span class="line"></span><br><span class="line">== 20190411210141 CreateUsuarios: migrating ===================================</span><br><span class="line">-- create_table(:usuarios)</span><br><span class="line">   -&gt; 0.3437s</span><br><span class="line">== 20190411210141 CreateUsuarios: migrated (0.3438s) ==========================</span><br><span class="line"></span><br><span class="line">== 20190411210248 CreatePosts: migrating ======================================</span><br><span class="line">-- create_table(:posts)</span><br><span class="line">   -&gt; 0.3559s</span><br><span class="line">== 20190411210248 CreatePosts: migrated (0.3560s) =============================</span><br><span class="line"></span><br><span class="line"><span class="string">"6 usuarios creados"</span></span><br><span class="line"><span class="string">"3 roles creados"</span></span><br><span class="line"><span class="string">"5 post creados"</span></span><br></pre></td></tr></table></figure>
<p>Y hasta ahora todo bien, todo correcto :v</p>
<p>Pero empecemos con lo más interesante, vamos con la autenticación, para esto es necesario primero que todo incluir en el Gemfile dos gemas:</p>
<ol>
<li><code>gem &#39;jwt&#39;</code></li>
<li><code>gem &#39;dotenv-rails&#39;</code></li>
</ol>
<p>la primera es para jwt y la segunda es para poder utilizar el archivo .env que es donde colocaremos la key necesaria para el jwt, no olvidar el <code>bundle install</code> y luego en la raiz del proyecto crear el archivo <code>.env</code> y agregar <code>JWT_SECRET=&#39;l4m3j0rc14v3d31mund0&#39;</code> donde la clave puede ser lo que quieras.</p>
<p>Contnuamos ahora creando en /app una carpeta llamada jwt y dentro el archivo json_web_token.rb que es donde tendremos la clase JsonWebToken, el archivo contendra lo siguiente</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonWebToken</span></span></span><br><span class="line">    JWT_SECRET = ENV[<span class="string">"JWT_SECRET"</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">encode</span><span class="params">(payload, exp = <span class="number">24</span>.hours.from_now)</span></span></span><br><span class="line">        payload[<span class="symbol">:exp</span>] = exp.to_i</span><br><span class="line">        JWT.encode(payload, JWT_SECRET)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">decode</span><span class="params">(token)</span></span></span><br><span class="line">        body = JWT.decode(token, JWT_SECRET)[<span class="number">0</span>]</span><br><span class="line">        HashWithIndifferentAccess.new body</span><br><span class="line">    <span class="keyword">rescue</span> JWT::ExpiredSignature, JWT::VerificationError =&gt; e</span><br><span class="line">        raise ManejadorDeExcepciones::TokenExpirado, e.message</span><br><span class="line">    <span class="keyword">rescue</span> JWT::DecodeError, JWT::VerificationError =&gt; e</span><br><span class="line">        raise ManejadorDeExcepciones::TokenNoValido, e.message</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Dos funciones, <code>encode</code> y <code>decode</code>.</p>
<p>La primera recibe dos parametros (aunque el segundo puede ser vacio y por defecto le pondrá 24 horas), y crea el token.</p>
<p>La segunda solo recibe como parametro un token y lo decodifica, luego se hace un rescue para manejar los errores en caso de que el token haya vencido o no sea valido, este manejador de errores lo crearemos a continuación, por lo tanto procedemos a crear un archivo en app/controllers/concerns/manejador_de_excepciones.rb</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ManejadorDeExcepciones</span> <span class="title">extend</span> <span class="title">ActiveSupport::Concern</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TokenNoValido</span> &lt; StandardError;</span> <span class="keyword">end</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TokenExpirado</span> &lt; StandardError;</span> <span class="keyword">end</span></span><br><span class="line">    included <span class="keyword">do</span></span><br><span class="line">        rescue_from ManejadorDeExcepciones::TokenNoValido <span class="keyword">do</span> <span class="params">|_error|</span></span><br><span class="line">            render <span class="symbol">json:</span> &#123;<span class="symbol">mensaje:</span> <span class="string">"¡Acceso denegado!. Token inválido suministrado."</span>&#125;, <span class="symbol">status:</span> <span class="symbol">:unauthorized</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        rescue_from ManejadorDeExcepciones::TokenExpirado <span class="keyword">do</span> <span class="params">|_error|</span></span><br><span class="line">            render <span class="symbol">json:</span> &#123;<span class="symbol">mensaje:</span> <span class="string">"¡Acceso denegado!. Token expirado"</span>&#125;, <span class="symbol">status:</span> <span class="symbol">:unauthorized</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Esté archivo recibira los errores de la clase JWT y los manejará para devolver el mensaje de error, ahora tenemos que incluirlo en el appliation_controller para poder utilizarlo en las demás clases</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationController</span> &lt; ActionController::Base</span></span><br><span class="line">    <span class="keyword">include</span> ManejadorDeExcepciones</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Ahora procedemos a crear una carpeta llamada auth (o como quieran) dentro de app y dentro un archivo authentication.rb que es donde estará la clase Authentication que será la encargada de autenticar al usuario y generar el token, esperemos que se entienda con solo verla.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authentication</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(usuario)</span></span></span><br><span class="line">        @correo = usuario[<span class="symbol">:correo</span>]</span><br><span class="line">        @password = usuario[<span class="symbol">:password</span>]</span><br><span class="line">        @usuario = Usuario.find_by(<span class="symbol">correo:</span> @correo)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">autenticar</span></span></span><br><span class="line">        @usuario &amp;&amp; @usuario.authenticate(@password)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generar_token</span></span></span><br><span class="line">        JsonWebToken.encode(&#123;<span class="symbol">usuario_id:</span> @usuario.id, <span class="symbol">correo:</span> @usuario.correo&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>teniendo esto, esperariamos que nuestra autenticación ya funcionara, entonces la probamos creando una ruta al controlador de sesión en config/routes.rb (como estoy manejando las carpetas ap1 y v1 en mi proyecto colocaré los namespace, si quieres los puedes obviar)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Rails.application.routes.draw <span class="keyword">do</span></span><br><span class="line">  namespace <span class="symbol">:api</span> <span class="keyword">do</span></span><br><span class="line">    namespace <span class="symbol">:v1</span> <span class="keyword">do</span></span><br><span class="line">      post <span class="string">'login'</span>, <span class="symbol">to:</span> <span class="string">'session#login'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Ahora creamos los controladores para ir probando que todo funciona hasta aquí, quedaría algo así (obviar las carpetas api y v1 si lo deseas)</p>
<p><img src="/images/controladores.png" alt=""></p>
<p>y en session_controller</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::V1::SessionController</span> &lt; ApplicationController</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span></span></span><br><span class="line">        auth = Authentication.new(login_params)</span><br><span class="line">        <span class="keyword">if</span>(auth.autenticar)</span><br><span class="line">            render <span class="symbol">json:</span> &#123;<span class="symbol">mensaje:</span> <span class="string">"¡Inicio de sesión correcto!"</span>, <span class="symbol">token:</span> auth.generar_token&#125;, <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            render <span class="symbol">json:</span> &#123;<span class="symbol">mensaje:</span> <span class="string">"Correo o Contraseña incorrectos"</span>&#125;, <span class="symbol">status:</span> <span class="symbol">:unauthorized</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login_params</span></span></span><br><span class="line">        params.permit(<span class="symbol">:correo</span>, <span class="symbol">:password</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>y luego para poder probar, ruby espera un csrf_token en cada solicitud pero aquí no lo utilizaremos por lo que nos toca deshabilitarlo agregando en application_controller <code>protect_from_forgery with: :null_session</code> y ahora si podremos probar (en mi caso lo haré con postman y enviando el usuario que he creado en el seed como admin)</p>
<p><img src="/images/primerPruebaLogin.png" alt=""></p>
<p>¡Y hasta aquí todo está funcionando correctamente!</p>
<p>pero hasta este punto todo el mundo puede hacer lo que le de la gana despues de haber obtenido el token, hasta un visitante podría eliminar o actualizar algo (en caso de tener creados los metodos en los controladores) y es cuando entra en juego la gema cancancan que es la que nos permitirá gestionar que permisos tiene cada usuario dependiendo de su rol, y lo hace de una manera muy elegante, lo primero entonces es instalarla agregando <code>gem &#39;cancancan&#39;</code> en el Gemfile y luego como no ejecutar <code>bundle install</code>, a continuación despues de instalada debemos ejecutar en consola <code>rails g cancan:ability</code>  para que se cree el archivo ability.rb dentro de la carpeta app/models/, si da error pues lo crear manual xD.</p>
<p>Una vez ubicado el archivo vemos que tiene la clase Ability creada y el inicializador de está misma, como nuestro proyecto tiene 3 roles lo que haremos es que cada vez que soliciten autorización les devolveremos una función dependiendo del rol del usuario para saber que puede hacer y que no, así:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ability</span></span></span><br><span class="line">  <span class="keyword">include</span> CanCan::Ability</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(usuario)</span></span></span><br><span class="line">    send(<span class="string">"<span class="subst">#&#123;usuario.rol.nombre&#125;</span>_permisos"</span>, usuario)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">administrador_permisos</span><span class="params">(usuario)</span></span></span><br><span class="line">    can <span class="symbol">:manage</span>, <span class="symbol">:all</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cliente_permisos</span><span class="params">(usuario)</span></span></span><br><span class="line">    can <span class="symbol">:read</span>, Post, <span class="symbol">:all</span></span><br><span class="line">    can <span class="symbol">:manage</span>, Post, &#123; <span class="symbol">usuario_id:</span> usuario.id&#125;</span><br><span class="line">    can [<span class="symbol">:read</span>, <span class="symbol">:update</span>], Usuario, &#123; <span class="symbol">id:</span> usuario.id &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">visitante_permisos</span><span class="params">(usuario)</span></span></span><br><span class="line">    can <span class="symbol">:read</span>, Post, <span class="symbol">:all</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">lista_de_permisos</span></span></span><br><span class="line">usuario_params</span><br><span class="line">        params.permit(<span class="symbol">:correo</span>, <span class="symbol">:password</span>, <span class="symbol">:rol_id</span>)</span><br><span class="line">    <span class="keyword">end</span>    rules.map <span class="keyword">do</span> <span class="params">|rule|</span></span><br><span class="line">     object = &#123; <span class="symbol">acciones:</span> rule.actions, <span class="symbol">sobre:</span> rule.subjects.map&#123; <span class="params">|s|</span> s.is_a?(Symbol) ? s : s.name &#125; &#125;</span><br><span class="line">      object[<span class="symbol">:condiciones</span>] = rule.conditions <span class="keyword">unless</span> rule.conditions.blank?</span><br><span class="line">      object[<span class="symbol">:inverted</span>] = <span class="literal">true</span> <span class="keyword">unless</span> rule.base_behavior</span><br><span class="line">      object</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Vemos  tres funciones una por cada rol, y lo que dice dentro de cada una es que el administrador puede hacer de todo, el cliente puede leer todos los post pero solo puede actualizar, crear, eliminar y borrar post que le pertenezcan a el y además solo podra ver y actualizar un usuario si es el mismo, en cuando al visitante solamente puede leer todos los post, esto es maravilloso nos ahorramos hacer un monton de if (que yo habría hecho si esta gema no existiera xD) en cada controlador dependiendo del rol del usuario; tambien vemos un metodo llamado lista_de_permisos que este lo que nos retorna es que puede hacer cada rol, ahora lo vemos.</p>
<p>Para probarlo en el controlador de usuarios escribiremos los siguientes metodos</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::V1::UsuariosController</span> &lt; ApplicationController</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></span><br><span class="line">        usuarios = Usuario.all</span><br><span class="line">        render <span class="symbol">json:</span> usuarios, <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span></span></span><br><span class="line">        usuario = Usuario.new(usuario_params)</span><br><span class="line">        <span class="keyword">if</span> usuario.save</span><br><span class="line">            render <span class="symbol">json:</span> usuario, <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            render <span class="symbol">json:</span> <span class="string">"error"</span>, <span class="symbol">status:</span> <span class="symbol">:unprocessable_entity</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">        usuario = Usuario.find(params[<span class="symbol">:id</span>])</span><br><span class="line">        permisos = Ability.new(usuario).lista_de_permisos</span><br><span class="line">        render <span class="symbol">json:</span> &#123;<span class="symbol">usuario:</span> usuario, <span class="symbol">permisos:</span> permisos&#125;, <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">usuario_params</span></span></span><br><span class="line">        params.permit(<span class="symbol">:correo</span>, <span class="symbol">:password</span>, <span class="symbol">:rol_id</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Y desde postman probamos con el usuario 1 que es el admin</p>
<p><img src="/images/lista_de_permisos_admin.png" alt=""></p>
<p>Con el usuario 2 que es un usuario normal (cliente)</p>
<p><img src="/images/lista_de_permisos_cliente.png" alt=""></p>
<p>y vemos que por cada petición nos retorna los permisos del usuario, las acciones que puede hacer,  sobre que modelo y si tiene alguna condición para poder hacer esa acción, quizá para algo puede servir esté metodo en algun momento.</p>
<p>Pero continuemos con el proceso, ahora para que cancancan pueda saber que hacer al momento de hacer una petición a algún controlador donde definamos la autorización el asume que tenemos la clase ability (que ya la tenemos en la carpeta app/models) y tambien un metodo llamado current_user y por lo tanto este metodo es el que procederemos a escribir ahora, entonces nos vamos a app/controllers/application_controller.rb y es aquí donde escribiremos el metodo para poder tenerlo disponible en toda la aplicación quedando así</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationController</span> &lt; ActionController::Base</span></span><br><span class="line">    protect_from_forgery <span class="symbol">with:</span> <span class="symbol">:null_session</span></span><br><span class="line">    <span class="keyword">include</span> ManejadorDeExcepciones</span><br><span class="line"></span><br><span class="line">    rescue_from CanCan::AccessDenied <span class="keyword">do</span> <span class="params">|exception|</span></span><br><span class="line">        render <span class="symbol">json:</span> &#123; <span class="symbol">mensaje:</span> exception.message &#125;, <span class="symbol">status:</span> <span class="number">403</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">current_user</span></span></span><br><span class="line">        <span class="keyword">if</span> token</span><br><span class="line">            @usuario_actual <span class="params">||</span>= Usuario.find(token[<span class="symbol">:usuario_id</span>])</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            @usuario_actual <span class="params">||</span>= Usuario.new(<span class="symbol">rol_id:</span> <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">token</span></span></span><br><span class="line">        valor = request.headers[<span class="symbol">:Authorization</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> valor.blank?</span><br><span class="line">        @token <span class="params">||</span>= JsonWebToken.decode(valor.split(<span class="string">" "</span>).last)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Lo que agregamos ahora es un rescue para manejar el error cuando el acceso sea denegado y devolver un error de no autorizado, el metodo current user que recupera el usuario actual dependiendo del token que venga en la solicitud y en caso de no haber ningun token se tomará como usuario visitante por eso se le asigna el rol tres (asumo que el rol con id tres es el visitante, lo pueden hacer dinamico con una consulta a la tabla rols).</p>
<p>Luego de esto volvemos el metodo show el usuarios_controller normal y le agregamos la directiva para que cancancan aplique la autorización en esa clase, así</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::V1::UsuariosController</span> &lt; ApplicationController</span></span><br><span class="line">    load_and_authorize_resource <span class="class"><span class="keyword">class</span>: "<span class="title">Usuario</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></span><br><span class="line">        usuarios = Usuario.all</span><br><span class="line">        render <span class="symbol">json:</span> usuarios, <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span></span></span><br><span class="line">        usuario = Usuario.new(usuario_params)</span><br><span class="line">        <span class="keyword">if</span> usuario.save</span><br><span class="line">            render <span class="symbol">json:</span> usuario, <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            render <span class="symbol">json:</span> <span class="string">"error"</span>, <span class="symbol">status:</span> <span class="symbol">:unprocessable_entity</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></span><br><span class="line">        usuario = Usuario.find(params[<span class="symbol">:id</span>])</span><br><span class="line">        render <span class="symbol">json:</span> usuario, <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">usuario_params</span></span></span><br><span class="line">        params.permit(<span class="symbol">:correo</span>, <span class="symbol">:password</span>, <span class="symbol">:rol_id</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Y probamos!</p>
<p>Pedimos el usuario con id 3 y enviamos el token del administrador, y lo devolverá sin problemas pues el puede realizar está acción</p>
<p><img src="/images/autorizacion_admin.png" alt=""></p>
<p>pero si lo hacemos con el token de un usuario normal</p>
<p><img src="/images/autorizacion_usuario_normal.png" alt=""></p>
<p>igual sucede con el usuario visitante</p>
<p><img src="/images/autorizacion_visitante.png" alt=""></p>
<p>El enviroment en postman contiene los tokens (el del visitante simplemente no es nada)</p>
<p><img src="/images/enviroment_postman.png" alt=""></p>
<p>Y con estás pruebas podemos ver que todo está funcionando correctamente!, ahora simplemente por deseo personal me gustaría ver el mensaje de error en español y de forma personalizada, por lo que toca hacer lo siguiente, en config/locales/ crearé el archivo es.yml y tendrá lo siguiente</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">es:</span></span><br><span class="line"><span class="attr">  unauthorized:</span></span><br><span class="line"><span class="attr">    manage:</span></span><br><span class="line"><span class="attr">      all:</span> <span class="string">"No estás autorizado para: [<span class="template-variable">%&#123;action&#125;</span>] =&gt; [<span class="template-variable">%&#123;subject&#125;</span>]."</span></span><br></pre></td></tr></table></figure>
<p>además de esto en application_controller agregamos un before_action y le pasamos una función para cambiar el locale de rails, quedaría así</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationController</span> &lt; ActionController::Base</span></span><br><span class="line">    before_action <span class="symbol">:set_locale</span></span><br><span class="line">    protect_from_forgery <span class="symbol">with:</span> <span class="symbol">:null_session</span></span><br><span class="line">    <span class="keyword">include</span> ManejadorDeExcepciones</span><br><span class="line"></span><br><span class="line">    rescue_from CanCan::AccessDenied <span class="keyword">do</span> <span class="params">|exception|</span></span><br><span class="line">        render <span class="symbol">json:</span> &#123; <span class="symbol">mensaje:</span> exception.message &#125;, <span class="symbol">status:</span> <span class="number">403</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">current_user</span></span></span><br><span class="line">        <span class="keyword">if</span> token</span><br><span class="line">            @usuario_actual <span class="params">||</span>= Usuario.find(token[<span class="symbol">:usuario_id</span>])</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            @usuario_actual <span class="params">||</span>= Usuario.new(<span class="symbol">rol_id:</span> <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">token</span></span></span><br><span class="line">        valor = request.headers[<span class="symbol">:Authorization</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> valor.blank?</span><br><span class="line">        @token <span class="params">||</span>= JsonWebToken.decode(valor.split(<span class="string">" "</span>).last)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_locale</span></span></span><br><span class="line">        I18n.locale = <span class="string">"es"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Haremos otra prueba y veremos los errores, en este caso trataremos de crear un nuevo usuario</p>
<p>Token de visitante</p>
<p><img src="/images/crear_usuario_visitante.png" alt=""></p>
<p>Token usuario</p>
<p><img src="/images/crear_usuario_usuario.png" alt=""></p>
<p>Y por ultimo con el administrador</p>
<p><img src="/images/crear_usuario_admin.png" alt=""></p>
<p>Y así mismo pasaría con los demás metodos, nuestra aplicación tendrá un manejo de autenticación un autorización un poco más organizado y mejor elaborado graciás a estás gemas.</p>
<p>Si algó no está bien escrito o hay algun error pido disculpas, para dudas o comentarios estoy en las redes como @JoralmoPro.</p>
<p>Para escribir este tutorial me he guidao y tal vez copiado algun trozo de código de <a href="https://medium.com/@noordean/authentication-with-jwt-in-rails-api-71102387c0b0" target="_blank" rel="noopener">aquí</a>, <a href="https://github.com/stalniy/rails-cancan-api-example" target="_blank" rel="noopener">aquí</a>, <a href="https://github.com/CanCanCommunity/cancancan/wiki/exception-handling" target="_blank" rel="noopener">aquí</a>, <a href="https://culttt.com/2016/01/20/implementing-roles-and-permissions-in-ruby-on-rails/" target="_blank" rel="noopener">aquí</a> y <a href="https://riptutorial.com/ruby-on-rails/example/10259/getting-started-with-cancan" target="_blank" rel="noopener">aquí</a>.</p>
<p><a href="https://gitlab.com/JoralmoPro/authrubyonrailstutorial" target="_blank" rel="noopener">Repositorio</a></p>
<blockquote>
<p>¡Nos vemos el linea!</p>
</blockquote>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/11/10/Ionic-Cloud-Vision-de-Google/">
                Ionic + Cloud Vision de Google
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-11-10</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <p>En está ocasión estaremos viendo como crear una imitación de la aplicación “Not hot dog app” que aparece en la famosa serie silycon valley, por si acaso no sabes cual es la aplicación te dejo un <a href="https://www.youtube.com/watch?v=pqTntG1RXSY" target="_blank" rel="noopener">link</a> para que le des un vistaso.</p>
<p>Para hacer posible la aplicación utilizaremos <a href="https://ionicframework.com/" target="_blank" rel="noopener">Ionic Framework</a> y el Api de Google <a href="https://cloud.google.com/vision/" target="_blank" rel="noopener">Cloud Vision</a>, por lo tanto lo primero que debemos hacer es instalar Ionic e iniciar un nuevo proyecto, lo conseguimos de la siguiente manera (infiero que tienes instalado <a href="https://nodejs.org/es/" target="_blank" rel="noopener">Node.js y npm</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i ionic -g &amp;&amp; ionic start hotDogoNo blank</span><br></pre></td></tr></table></figure>
<p>El primer comando instalara ionic de manera global en el sistema, el segundo iniciara un nuevo proyecto de ionic llamado hotDogoNo y con la plantilla blank, <a href="https://ionicframework.com/getting-started#cli" target="_blank" rel="noopener">acá</a> pueden ver más al respecto.</p>
<p>Ahora de momento iremos a la pagina de <a href="https://cloud.google.com/vision/" target="_blank" rel="noopener">Cloud Vision</a> y activamos la Api y guardamos el Api Key.</p>
<p>Abrimos el proyecto de ionic en nuestro editor favorito, y nos centraremos en la carpeta /src/ y ahora especificamente en el archivo /src/app/app.modules.ts donde importaremos el modulo http de angular con el que realizaremos las peticiones y también el modulo de la cámara para poder tomar la foto desde el celular y colocamos los módulos dentro del array de imports y providers respectivamente.</p>
<p>Para instalar el modulo de la cámara</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ionic cordova plugin add cordova-plugin-camera</span><br><span class="line">$ npm install --save @ionic-native/camera</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; <span class="keyword">from</span> <span class="string">'@angular/platform-browser'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ErrorHandler, NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IonicApp, IonicErrorHandler, IonicModule &#125; <span class="keyword">from</span> <span class="string">'ionic-angular'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SplashScreen &#125; <span class="keyword">from</span> <span class="string">'@ionic-native/splash-screen'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StatusBar &#125; <span class="keyword">from</span> <span class="string">'@ionic-native/status-bar'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HttpModule &#125; <span class="keyword">from</span> <span class="string">'@angular/http'</span>; <span class="comment">//HttpModule</span></span><br><span class="line"><span class="keyword">import</span> &#123; Camera &#125; <span class="keyword">from</span> <span class="string">'@ionic-native/camera'</span>; <span class="comment">//Camara</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; MyApp &#125; <span class="keyword">from</span> <span class="string">'./app.component'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  declarations: [</span><br><span class="line">    MyApp</span><br><span class="line">  ],</span><br><span class="line">  imports: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    IonicModule.forRoot(MyApp),</span><br><span class="line">    HttpModule <span class="comment">//Array de imporst</span></span><br><span class="line">  ],</span><br><span class="line">  bootstrap: [IonicApp],</span><br><span class="line">  entryComponents: [</span><br><span class="line">    MyApp</span><br><span class="line">  ],</span><br><span class="line">  providers: [</span><br><span class="line">    StatusBar,</span><br><span class="line">    SplashScreen,</span><br><span class="line">    &#123;provide: ErrorHandler, useClass: IonicErrorHandler&#125;,</span><br><span class="line">    Camera <span class="comment">// Array de providers</span></span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppModule &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>Por el momento es todo en este archivo.</p>
<p>Ahora vamos al archivo /src/ages/inicio/inicio.ts</p>
<blockquote>
<p>Yo he eliminado la pagina “home” que viene por defecto y he creado la pagina “inicio”</p>
</blockquote>
<p>En la pagina de inicio escribiremos el código necesario para la lógica de la aplicación, o sea, aquí capturamos la imagen y la enviamos a Cloud Vision para luego trabajar con el resultado que nos retorna, pero veamos y analicemos el código</p>
<blockquote>
<p><a href="https://cloud.google.com/vision/docs/request" target="_blank" rel="noopener">Aquí</a> pueden ver como es la estructura para enviar la petición a Cloud Vision</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; SplashScreen &#125; <span class="keyword">from</span> <span class="string">'@ionic-native/splash-screen'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IonicPage, NavController, NavParams &#125; <span class="keyword">from</span> <span class="string">'ionic-angular'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">'@angular/http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LoadingController &#125; <span class="keyword">from</span> <span class="string">'ionic-angular/components/loading/loading-controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Camera, CameraOptions &#125; <span class="keyword">from</span> <span class="string">'@ionic-native/camera'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ToastController &#125; <span class="keyword">from</span> <span class="string">'ionic-angular/components/toast/toast-controller'</span>;</span><br><span class="line"><span class="comment">// imports necesarios</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@IonicPage</span>(&#123;</span><br><span class="line">  <span class="comment">//Lazy loading</span></span><br><span class="line">  name: <span class="string">"inicio"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">'page-inicio'</span>,</span><br><span class="line">  templateUrl: <span class="string">'inicio.html'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> InicioPage &#123;</span><br><span class="line">  <span class="comment">//Variables utilizadas en la aplicación</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//Apikey de google cloud vision</span></span><br><span class="line">  googleCloudVisionAPIKey = <span class="string">"TUAPIKEY"</span>;</span><br><span class="line">  <span class="comment">//Para obtener las respuestas de google cloud vision</span></span><br><span class="line">  labels: <span class="built_in">any</span>[] = [];</span><br><span class="line">  <span class="comment">//Para dar vista previa a la imgen</span></span><br><span class="line">  imagen: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">//Respuesta de google cloud vison</span></span><br><span class="line">  resultado: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">//variable de control de si es o no es hotdog</span></span><br><span class="line">  es: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> navCtrl: NavController, <span class="keyword">public</span> navParams: NavParams, <span class="keyword">public</span> splashScreen: SplashScreen, <span class="keyword">public</span> http: Http, <span class="keyword">public</span> loader: LoadingController, <span class="keyword">private</span> camera: Camera, <span class="keyword">public</span> toast: ToastController</span>) &#123;</span><br><span class="line">      <span class="comment">//Objetos necesarios, necesarios tambien agregarlos en el app.module.ts</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ionViewDidLoad() &#123;</span><br><span class="line">    <span class="comment">//Para ocultar el splash de ionic</span></span><br><span class="line">    <span class="keyword">this</span>.splashScreen.hide();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//Funcion para hacer la petición a google cloud vision, estructura necesaria para la petición segun la documentación</span></span><br><span class="line">  getLabels(base64) &#123;</span><br><span class="line">    <span class="keyword">const</span> body = &#123;</span><br><span class="line">      <span class="string">"requests"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"image"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: base64</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"features"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">"type"</span>: <span class="string">"LABEL_DETECTION"</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Retornar la respuesta</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.http.post(<span class="string">`https://vision.googleapis.com/v1/images:annotate?key=<span class="subst">$&#123;this.googleCloudVisionAPIKey&#125;</span>`</span>, body)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Funcion para abrir la camara y procesar la imagen</span></span><br><span class="line">  tomarFoto() &#123;</span><br><span class="line">    <span class="comment">//Crear loader</span></span><br><span class="line">    <span class="keyword">let</span> loader = <span class="keyword">this</span>.loader.create(&#123;</span><br><span class="line">      content: <span class="string">'Ejecutando analisis...'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//Mostrar loader</span></span><br><span class="line">    loader.present();</span><br><span class="line">    <span class="comment">//Opciones para abrir la camara</span></span><br><span class="line">    <span class="keyword">const</span> opciones: CameraOptions = &#123;</span><br><span class="line">      <span class="comment">//Calidad de la imagen</span></span><br><span class="line">      quality: <span class="number">100</span>,</span><br><span class="line">      <span class="comment">//Alto de la imagen</span></span><br><span class="line">      targetHeight: <span class="number">500</span>,</span><br><span class="line">      <span class="comment">//Ancho de la imagen</span></span><br><span class="line">      targetWidth: <span class="number">500</span>,</span><br><span class="line">      <span class="comment">//Tip de respuesta (base64 en este caso)</span></span><br><span class="line">      destinationTyp-e: <span class="keyword">this</span>.camera.DestinationType.DATA_URL,</span><br><span class="line">      <span class="comment">//Tipo png</span></span><br><span class="line">      encodingType: <span class="keyword">this</span>.camera.EncodingType.PNG,</span><br><span class="line">      mediaType: <span class="keyword">this</span>.camera.MediaType.PICTURE,</span><br><span class="line">      <span class="comment">//Abrir desde la camara (se puede tambien desde la galeria)</span></span><br><span class="line">      sourceType: <span class="keyword">this</span>.camera.PictureSourceType.CAMERA</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Abirmos la camara pasando las opciones antes estipuladas</span></span><br><span class="line">    <span class="keyword">this</span>.camera.getPicture(opciones).then(<span class="function">(<span class="params">img</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.labels = [];</span><br><span class="line">      <span class="keyword">this</span>.es = <span class="literal">false</span>;</span><br><span class="line">      <span class="comment">//Hacemos la petición a google cloud vision</span></span><br><span class="line">      <span class="keyword">this</span>.getLabels(img).subscribe(<span class="function">(<span class="params">resultados</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//Hacemos la variable imagen igual a la imagen obtenida por la camara para mostrar la vista previa</span></span><br><span class="line">        <span class="keyword">this</span>.imagen = img;</span><br><span class="line">        <span class="comment">//Obtenemos los resultados que nos da google</span></span><br><span class="line">        <span class="keyword">this</span>.resultado = resultados.json().responses;</span><br><span class="line">        <span class="comment">//Recorremos las etiquetas de la respuesta con map()</span></span><br><span class="line">        <span class="keyword">this</span>.resultado[<span class="number">0</span>].labelAnnotations.map(<span class="function"><span class="params">obj</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">//Guardamos las etiquetas en la variable labels</span></span><br><span class="line">          <span class="keyword">this</span>.labels.push(obj.description);</span><br><span class="line">          <span class="comment">//Si algunas de las etiquetas es "hot dog" entonces es un hot dog</span></span><br><span class="line">          <span class="keyword">if</span> (obj.description == <span class="string">"hot dog"</span>) <span class="keyword">this</span>.es = <span class="literal">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//Quitamos el loader</span></span><br><span class="line">        loader.dismiss();</span><br><span class="line">      &#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//Por si acaso ocurre un error</span></span><br><span class="line">        loader.dismiss();</span><br><span class="line">        <span class="keyword">this</span>.mostrarToast(err.message, <span class="number">5000</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//Por si acaso ocurre un error</span></span><br><span class="line">      loader.dismiss();</span><br><span class="line">      <span class="keyword">this</span>.mostrarToast(err.message, <span class="number">5000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Funcion para mostrar mensaje de error recibe mensaje de error y la duración de el mensaje</span></span><br><span class="line">  mostrarToast(mensaje: <span class="built_in">string</span>, duracion: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.toast.create(&#123;</span><br><span class="line">      message: mensaje,</span><br><span class="line">      duration: duracion</span><br><span class="line">    &#125;).present();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>El anterior es el código de toda la lógica de la aplicación, bastante optimízable por cierto pero por cuestiones del tutorial lo escribí así.</p>
<p>Ahora en el archivo /src/ages/inicio/inicio.html tendremos los siguiente</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ion-header</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Color rojo de el navbar --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ion-navbar</span> <span class="attr">color</span>=<span class="string">"danger"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ion-title</span>&gt;</span>¿Hog dog o no?<span class="tag">&lt;/<span class="name">ion-title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ion-navbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ion-header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ion-content</span> <span class="attr">padding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ion-row</span> <span class="attr">margin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ion-card</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Si la imagen existe, mostramos su vista previa --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> *<span class="attr">ngIf</span>=<span class="string">"imagen"</span> [<span class="attr">src</span>]=<span class="string">"'data:image/png;base64,' + imagen"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ion-card</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ion-row</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Si existe ya un resultado, mostraremos lo siguiente --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ion-col</span> *<span class="attr">ngIf</span>=<span class="string">"resultado"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Si la variable "es" esta en true, mostramos que es un hotdog, de lo contrario pues mostramos que no es hotdog --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">"es"</span> <span class="attr">color</span>=<span class="string">"secondary"</span> <span class="attr">ion-button</span> <span class="attr">full</span>&gt;</span></span><br><span class="line">      ¡Es un Hotdog!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">"!es"</span> <span class="attr">color</span>=<span class="string">"danger"</span> <span class="attr">ion-button</span> <span class="attr">full</span>&gt;</span></span><br><span class="line">      ¡No es Hotdog!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Si no es hotdog mostramos las etiquetas de lo que posiblemente está en la imagen --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">"!es"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h3</span>&gt;</span>Posiblemente sea<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- Recorremos la variable labels --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ion-chip</span> <span class="attr">color</span>=<span class="string">"secondary"</span> *<span class="attr">ngFor</span>=<span class="string">"let label of labels"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Mostramos una por una --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ion-label</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class="tag">&lt;/<span class="name">ion-label</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ion-chip</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ion-col</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Boton flotante que ejecuta la funcion tomarFoto() --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ion-fab</span> <span class="attr">bottom</span> <span class="attr">right</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">color</span>=<span class="string">"danger"</span> <span class="attr">ion-fab</span> (<span class="attr">click</span>)=<span class="string">"tomarFoto()"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ion-icon</span> <span class="attr">name</span>=<span class="string">"camera"</span>&gt;</span><span class="tag">&lt;/<span class="name">ion-icon</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ion-fab</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ion-content</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Y ahora veamos un poquito la aplicación funcionando</p>
<p><a href="http://www.youtube.com/watch?v=7YL4uP7oLhg" target="_blank" rel="noopener"><img src="http://img.youtube.com/vi/7YL4uP7oLhg/0.jpg" alt="IMAGE ALT TEXT HERE"></a></p>
<p>Mis disculpas por la alerta molestosa que sale al grabar el mi celular xD</p>
<p><a href="https://gitlab.com/JoralmoPro/hotDogoNo" target="_blank" rel="noopener">Código en gitlab</a></p>
<p>Cualquier duda o sugerencia estoy en las redes como @JoralmoPro</p>
<blockquote>
<p>Nos vemos en linea</p>
</blockquote>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/11/07/Como-crear-un-chatbot-Node-js-y-DialogFlow/">
                Como crear un chatbot - Node.js y DialogFlow
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-11-07</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="Bienvenido-a-este-post-donde-tratare-de-explicar-como-crear-un-bot-utilizando-DialogFlow-y-algunos-paquetes-de-npm-con-un-proyecto-de-Node-js-empecemos"><a href="#Bienvenido-a-este-post-donde-tratare-de-explicar-como-crear-un-bot-utilizando-DialogFlow-y-algunos-paquetes-de-npm-con-un-proyecto-de-Node-js-empecemos" class="headerlink" title="Bienvenido a éste post donde trataré de explicar como crear un bot utilizando DialogFlow y algunos paquetes de npm con un proyecto de Node.js, empecemos."></a>Bienvenido a éste post donde trataré de explicar como crear un bot utilizando DialogFlow y algunos paquetes de npm con un proyecto de Node.js, empecemos.</h4><h4 id="Primero-que-todo-veamos-que-es-DialogFlow-traducido-de-su-doc-oficial"><a href="#Primero-que-todo-veamos-que-es-DialogFlow-traducido-de-su-doc-oficial" class="headerlink" title="Primero que todo veamos que es DialogFlow (traducido de su doc. oficial):"></a>Primero que todo veamos que es DialogFlow (traducido de su doc. oficial):</h4><blockquote>
<p>Ofrezca a los usuarios nuevas formas de interactuar con su producto creando interfaces de conversación atractivas basadas en texto y voz, como aplicaciones de voz y chatbots, con tecnología de AI. Conéctese con los usuarios de su sitio web, la aplicación móvil, el Asistente de Google, Amazon Alexa, Facebook Messenger y otras plataformas y dispositivos populares.</p>
</blockquote>
<h5 id="Habiendo-leido-un-poco-vemos-que-dialogflow-permite-crear-chatbots-de-manera-mas-sencilla-ofreciendonos-gran-cantidad-de-herramientas-para-facilitarnos-el-proceso"><a href="#Habiendo-leido-un-poco-vemos-que-dialogflow-permite-crear-chatbots-de-manera-mas-sencilla-ofreciendonos-gran-cantidad-de-herramientas-para-facilitarnos-el-proceso" class="headerlink" title="Habiendo leído un poco, vemos que dialogflow permite crear chatbots de manera más sencilla ofreciéndonos gran cantidad de herramientas para facilitarnos el proceso."></a>Habiendo leído un poco, vemos que dialogflow permite crear chatbots de manera más sencilla ofreciéndonos gran cantidad de herramientas para facilitarnos el proceso.</h5><p>Lo primero que debemos hacer es ir a la pagina de <a href="https://dialogflow.com/" target="_blank" rel="noopener">DialogFlow</a>, ir a la consola e iniciar sesión.</p>
<p>luego estando en la consola, hacemos click en “Create a new agent”</p>
<p><img src="/images/consolaDF.png" alt="Consola DialogFlow"></p>
<p>le deberan poner un nombre, elegir un idioma y un proyecto de google asociado, para crear un nuevo proyecto de google elegir “Create a new Google project”</p>
<p><img src="/images/nuevoBot.png" alt="Nuevo Agente"></p>
<p>Al pulsar el crear tardará un momento mientras se prepara el nuevo agente por parte de google.</p>
<p>Una vez creado tendremos 2 “Intents” creados, un Intent es lo que le permite al bot poder enterder una frase y saber como proceder, por ejemplo el intent “Default Welcome Intent” reconoce expresiones de usuario como</p>
<p><img src="/images/welcomeIntent.png" alt="Welcome intent"></p>
<p>a lo que respondería cosas como</p>
<p><img src="/images/resWelcomeIntent.png" alt="Respuesta welcome intent"></p>
<p>o sea que siempre que recibamos un mensaje de “Hola” por ejemplo, el bot contestará “¡Hola!” o alguna de las otras respuestas, lo podemos ver en el input “Try it now” de la parte superior derecha</p>
<p><img src="/images/probandoIntent.png" alt="Probando intent"></p>
<p>“user says” es lo que he dicho</p>
<p>“Default response” es lo que me ha contestado</p>
<p>“Intent” es el intent que ha procesado lo que el usuario ha dicho</p>
<p>“Action” es la acción que se ha ejecutado dentro del input al recibir el mensaje de Hola.</p>
<p>Tambien vemos que hay un intent llamado “Default Fallback Intent” que es el que se ejecuta cuando el usuario dice una frase que ningun intent puede procesar, a lo que el bot contestaría algo como “Ups, no he entendido a que te refieres.”, “¿Podrías repetirlo, por favor?” o “¿Disculpa?”.</p>
<p>En esté tutorial buscaremos crear un bot que nos responda a cosas como:</p>
<blockquote>
<p>Usuario: ¿Cuánto es 2+2?</p>
</blockquote>
<blockquote>
<p>Bot: 2+2 es 4</p>
</blockquote>
<blockquote>
<p>Usuario: 2-2</p>
</blockquote>
<blockquote>
<p>Bot: 2-2 es 0</p>
</blockquote>
<blockquote>
<p>Usuario: 2*2</p>
</blockquote>
<blockquote>
<p>Bot: 2*2 es 4</p>
</blockquote>
<p>Y así con la división; para lograr esto, debemos crear intents para manejar cada mensaje del usuario y darle el manejo respectivo a cada uno, para eso en el panel izquierdo, al lado de “Intents” hay un + para crear nuevos intents, clickeamos, le damos un nombre y luego guardar:</p>
<p><img src="/images/nuevoIntent.png" alt="Nuevo Intent"></p>
<p>Luego de creado clickeamos “Add Training Phrases” para entrenar al bot con frases dichas por el usuario, pero a diferencia de los dos intents antes mostrados este tendrá dos variables, num1 y num2 para saber a que numeros aplicarle la operación de suma y eso lo hacemos de la siguiente manera</p>
<p><img src="/images/escribirFrase.png" alt="Escribir expresion"></p>
<p>luego de escribir 2+2, seleccionamos el primer 2 y se despliega una ventanita</p>
<p><img src="/images/ventanita.png" alt="Ventanita"></p>
<p>en la que debemos elegir el tipo de dato de la variable, o tambien conocidos como “Entities”, pueden leer mas acerca de los tipos <a href="https://dialogflow.com/docs/reference/system-entities" target="_blank" rel="noopener">aquí</a>, para éste caso elegiremos @sys.number y le pondremos de nombre num1</p>
<p><img src="/images/num1.png" alt="num1"></p>
<p>y lo mismo con el otro número, quedando así</p>
<p><img src="/images/num2.png" alt="num2"></p>
<p>por último pulsamos enter, al agregar mas frases automáticamente se reconocerán las variables luego de pulsar enter, he agregado tres más</p>
<p><img src="/images/masFrases.png" alt="Frases"></p>
<p>En este caso no tendremos respuestas en el “Response” sino que manejaremos cada petición por medio de un <a href="https://es.wikipedia.org/wiki/Webhook" target="_blank" rel="noopener">webhook</a> que más adelante prepararemos, pero para esto debemos habilitar el “Fulfillment” en el intent, está al final solo clickeamos en “Enable Fulfillment” y luego en “Enable webhook call for this intent”.</p>
<p><img src="/images/enableFulfillment.png" alt="Enable Fulfillment"></p>
<p><img src="/images/enableWebhook.png" alt="Enable webhook"></p>
<p>También debemos ponerle un nombre a la acción que se está ejecutando en ese intent para saber como manejarla, y colocar como requeridos los 2 parametros necesarios para dar una respuesta, en este caso num1 y num2, así</p>
<p><img src="/images/actionIntent.png" alt="Action intent"></p>
<p>Luego de todo esto es importante dar click en “Save” para guardar lo que hemos hecho, después de eso veremos unas alertas que dicen</p>
<blockquote>
<p>Intent saved</p>
</blockquote>
<blockquote>
<p>Agent training started</p>
</blockquote>
<blockquote>
<p>Agent training completed</p>
</blockquote>
<p>Lo que nos dicen que el intent se guardó, se empezó a entrenar el agente y luego que se terminó el entrenamiento, no podemos aún probar su funcionamiento pues no hemos preparado aun el webhook para poder dar una respuesta, y es aquí cuando entra al juego Node.js que es el que utilizaremos para hacer un servidor y manejar todas las solicitudes hechas al bot y poder dar una respuesta al usuario, veamos como.</p>
<p>Lo primero es crear una carpeta (yo le pondré de nombre “botEjemplo”) y dentro de esta creamos un nuevo proyecto de node con </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br></pre></td></tr></table></figure>
<p><img src="/images/npmInit.png" alt="npm init -y"></p>
<p>Seguido de eso instalaremos algunos paquetes para poder montar el servidor</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i body-parser express ngrok -D</span><br></pre></td></tr></table></figure>
<p>Luego creamos el archivo index.js y lo abrimos en nuestro editor de codigo preferido y escribimos por el momento lo siguiente</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">"body-parser"</span>);</span><br><span class="line"><span class="keyword">const</span> ngrok = <span class="built_in">require</span>(<span class="string">'ngrok'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">var</span> ip = process.env.IP || <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.body.queryResult.action == <span class="string">"suma"</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> num1 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num1);</span><br><span class="line">        <span class="keyword">let</span> num2 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num2);</span><br><span class="line">        <span class="keyword">let</span> sum = num1 + num2;</span><br><span class="line">        response = num1 + <span class="string">" + "</span> + num2 + <span class="string">" es "</span> + sum;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="string">"fulfillmentText"</span>: response</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, ip);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="keyword">await</span> ngrok.connect(port);</span><br><span class="line">    <span class="built_in">console</span>.log(url);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>Para explicar un poco, el anterior código prepara un servidor con express, esto es porque al habilitar el webhook en dialogflow lo que pasará cada vez que le hagamos una pregunta al bot el dirigirá la petición a la url que le proporcionemos del webhook para procesar la pregunta y dar una respuesta, es por eso que instalamos <a href="https://ngrok.com/" target="_blank" rel="noopener">ngrok</a></p>
<blockquote>
<p>ngrok expone los servidores locales detrás de NAT y firewalls a la Internet pública a través de túneles seguros.</p>
</blockquote>
<p>todas estas solicitudes son enviadas a la raiz del servidor “/“ es por esto que es importante colocar un nombre a la acción del intent, para saber como manejarla dentro del servidor, dialogflow nos envía una serie de datos en cada solicitud, entre estas el “queryResult.action” que es donde viene la acción ejecutada desde ese intent, tambien “queryResult.parameters” que es donde vienen los parámetros que el usuario proporcionó en el mensaje, mas especificamente en esté caso los dos numeros (num1, num2) , luego de poner a escuchar el servidor ejecutamos una función para poner en “linea” nuestro servidor con ngrok, la url que nos aparecerá en consola luego de hacer “node index.js” es la que colocaremos de webhook en dialogflow así</p>
<p><img src="/images/urlWebhook.png" alt="node index.js"></p>
<p><img src="/images/webhookDialogflow.png" alt="Webhook DialogFlow"></p>
<p>luego de habilitar el webhook bajamos y hacemos click en “Save” para guardar, luego de esto podemos probar el bot con la suma</p>
<p><img src="/images/pruebaSuma.png" alt="Prueba suma"></p>
<p>y ¡boom! el bot está funcionando, en la anterior captura se puede ver de nuevo lo enviado por el usuario, la respuesta (que hemos enviado desde el servidor de node), el intent, la acción y los parametros.</p>
<p>Ahora de igual modo crearemos los intent para restar, multiplicar y dividir y agregaremos su respectiva funcionalidad en el código del servidor.</p>
<p><img src="/images/restaIntent.png" alt="Resta Intent"></p>
<p><img src="/images/multiplicacionIntent.png" alt="Multiplicación intent"></p>
<p><img src="/images/divisionIntent.png" alt="División intent"></p>
<h2 id="No-olvidar-colocar-el-nombre-de-la-accion-colocar-los-parametros-como-requeridos-y-activar-el-fulfillment"><a href="#No-olvidar-colocar-el-nombre-de-la-accion-colocar-los-parametros-como-requeridos-y-activar-el-fulfillment" class="headerlink" title="No olvidar colocar el nombre de la acción, colocar los parámetros como requeridos y activar el fulfillment"></a>No olvidar colocar el nombre de la acción, colocar los parámetros como requeridos y activar el fulfillment</h2><p>Y el código:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (req.body.queryResult.action == <span class="string">"suma"</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> num1 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num1);</span><br><span class="line">        <span class="keyword">let</span> num2 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num2);</span><br><span class="line">        <span class="keyword">let</span> sum = num1 + num2;</span><br><span class="line">        response = num1 + <span class="string">" + "</span> + num2 + <span class="string">" es "</span> + sum;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="string">"fulfillmentText"</span>: response</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(req.body.queryResult.action == <span class="string">"resta"</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> num1 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num1);</span><br><span class="line">        <span class="keyword">let</span> num2 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num2);</span><br><span class="line">        <span class="keyword">let</span> sum = num1 - num2;</span><br><span class="line">        response = num1 + <span class="string">" - "</span> + num2 + <span class="string">" es "</span> + sum;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="string">"fulfillmentText"</span>: response</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(req.body.queryResult.action == <span class="string">"multiplicacion"</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> num1 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num1);</span><br><span class="line">        <span class="keyword">let</span> num2 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num2);</span><br><span class="line">        <span class="keyword">let</span> sum = num1 * num2;</span><br><span class="line">        response = num1 + <span class="string">" * "</span> + num2 + <span class="string">" es "</span> + sum;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="string">"fulfillmentText"</span>: response</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(req.body.queryResult.action == <span class="string">"division"</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> num1 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num1);</span><br><span class="line">        <span class="keyword">let</span> num2 = <span class="built_in">parseFloat</span>(req.body.queryResult.parameters.num2);</span><br><span class="line">        <span class="keyword">let</span> sum = num1 / num2;</span><br><span class="line">        response = num1 + <span class="string">" / "</span> + num2 + <span class="string">" es "</span> + sum;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="string">"fulfillmentText"</span>: response</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Guardamos y volvemos a correr el servidor</p>
<h3 id="Importante-cambiar-la-url-del-fulfillment-cada-vez-que-corramos-el-servidor"><a href="#Importante-cambiar-la-url-del-fulfillment-cada-vez-que-corramos-el-servidor" class="headerlink" title="Importante cambiar la url del fulfillment cada vez que corramos el servidor"></a>Importante cambiar la url del fulfillment cada vez que corramos el servidor</h3><p>y de esté modo ya estária nuestro bot funcionando, de manera rápida haremos una integración con telegram para probar el bot de manera mas comoda.</p>
<p>Lo primero es ir al apartado de “Integrations” en DialogFlow y habilitar Telegram, nos pedirá un token</p>
<p><img src="/images/integracionTelegram.png" alt="Integranción telegram"></p>
<p>Para conseguir este token debemos creal el bot en telegram, <a href="https://web.telegram.org/#/im?p=@BotFather" target="_blank" rel="noopener">aquí</a>, estando en el chat con el BotFather en telegram le escribimos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/newbot</span><br></pre></td></tr></table></figure>
<p>y nos preguntará el nombre del bot y el nombre de usuario del bot</p>
<p><img src="/images/crearBot.png" alt="Crear Bot"></p>
<p>nos resaltará el token en rojo, es el que pondremos en DialogFlow, lo pegamos y pulsamos start y listo ya tendremos la integración con telegram, probamos, para probar hay que iniciar la conversación con el bot en telegram, a mi bot le he puesto por nombre de usuario “EjemploJpBot” por lo tanto para poder iniciar la conversación con el debo ir a la url <a href="https://web.telegram.org/#/im?p=@EjemploJpBot" target="_blank" rel="noopener">https://web.telegram.org/#/im?p=@EjemploJpBot</a>, deberan editar la url con el nombre de usuario de su bot al final, al probar:</p>
<p><img src="/images/pruebaBotTelegram.png" alt="Prueba bot Telegram"></p>
<h3 id="Asegurarse-de-tener-corriendo-el-servidor-de-node-para-que-funcione-el-bot"><a href="#Asegurarse-de-tener-corriendo-el-servidor-de-node-para-que-funcione-el-bot" class="headerlink" title="Asegurarse de tener corriendo el servidor de node para que funcione el bot"></a>Asegurarse de tener corriendo el servidor de node para que funcione el bot</h3><p>Y listo, estó seria todo por esté tutorial, creo que son buenas bases para poder crear nuevas y mejores cosas con dialogflow, espero haberme explicado bien y que hayas entendido esté paso a paso.</p>
<p><a href="https://github.com/Joralmo/botEjemplo" target="_blank" rel="noopener">Código del servidor</a></p>
<blockquote>
<p>¡Nos vemos en línea!</p>
</blockquote>

        </div>
    

</div>
            
        </section>
    </div>
</div>






</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>Acerca_de</h2>
                <p>
                    JoralmoPro, estudiante de 9no semestre de ingeniería de sistemas. <br> <small>Este tema fue desarrollado por <a href="https://github.com/klugjo">Jonathan Klughertz</a>. El código fuente está disponible en Github. Crear sitios web. Hacer magia</small>
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Posts_recientes</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/04/11/Autenticacion-y-manejo-de-roles-con-RubyOnRails/">Autenticación y manejo de</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/11/10/Ionic-Cloud-Vision-de-Google/">Ionic + Cloud Vision de G</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/11/07/Como-crear-un-chatbot-Node-js-y-DialogFlow/">Como crear un chatbot - N</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/Joralmo">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                        <li class="list-inline-item">
                            <a href="https://gitlab.com/JoralmoPro">
                                <span class="footer-icon-container">
                                    <i class="fa fa-gitlab"></i>
                                </span>
                            </a>
                        </li>
                        
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/JoralmoPro">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/iJoseAltamar">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/JoralmoPro">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:JoralmoPro@gmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @<a target="_blank" href="http://bit.ly/portafolioJP">JoralmoPro</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>