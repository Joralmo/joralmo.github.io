---
title: "Dos flujos con n8n + Evolution API en local (Docker): paso a paso b√°sico"
pubDate: 2025-09-25T12:00:00
description: "Gu√≠a r√°pida para montar en local dos flujos: Presentaci√≥n a nuevos contactos y Asistente personal que cotiza y env√≠a PDF. n8n y Evolution API corriendo en Docker."
tags:
  - n8n
  - whatsapp
  - automatizaci√≥n
  - docker
  - openai
slug: "/n8n-evolution-docker-flujos-basicos"
canonicalUrl: https://www.noemec.net/blog/n8n-evolution-docker-flujos-basicos
---

> En esta gu√≠a montamos **dos flujos** con **n8n** y **Evolution API** en local (ambos con **Docker**), usando **OpenAI** para los textos:
> 1) **Presentaci√≥n Nuevos Contactos** (env√≠a mensaje de presentaci√≥n por WhatsApp).  
> 2) **Asistente Personal** (entiende el mensaje del cliente, arma cotizaci√≥n y **env√≠a un PDF** por WhatsApp).

---

## 0) Preparaci√≥n (local con Docker)

### n8n (Docker)
Usa la imagen oficial:

~~~bash
docker run -d --name n8n \
  -p 5678:5678 \
  -v n8n_data:/home/node/.n8n \
  -e N8N_HOST=localhost \
  -e N8N_EDITOR_BASE_URL=http://localhost:5678 \
  n8nio/n8n:latest
~~~

### Evolution API (Docker)
Levanta tu instancia de Evolution API (ajusta imagen y variables a tu build):

~~~bash
docker run -d --name evolution \
  -p 8080:8080 \
  -e AUTHENTICATION_API_KEY=TU_API_KEY \
  <imagen_evolution_api>
~~~

> Conecta WhatsApp (QR) seg√∫n la documentaci√≥n de tu imagen y guarda `API_KEY` y `BASE_URL`.

### Claves y credenciales en n8n
- **OpenAI**: crea API key y a√±√°dela como credencial.
- **Google Sheets** (si usas hoja): credencial OAuth2.
- **Evolution API**: credencial con `BASE_URL` + `API_KEY`.

---

## 1) Flujo: **Presentaci√≥n Nuevos Contactos**

### Objetivo
Tomar contactos (Nombre, N√∫mero) y **enviar por WhatsApp** un mensaje de presentaci√≥n personalizado.

### Estructura m√≠nima de nodos
1. **Manual Trigger** (o **Schedule** diario).  
2. **Google Sheets ‚Üí Read**: hoja `Contactos` con columnas `Nombre`, `Numero`.  
3. *(Opcional)* **Google Sheets ‚Üí Read**: hoja `Historial` para evitar duplicados.  
4. *(Opcional)* **Code**: filtra solo n√∫meros no presentes en `Historial`.  
5. **OpenAI (Chat/Agent)**: genera **plantilla** de mensaje con marcador `//REPLACENAME//`.  
6. **Split In Batches**: itera contacto por contacto.  
7. **Evolution API ‚Üí send-text**:
   - **N√∫mero**:
     ~~~twig
     {{ String($json["Numero"]).replace(/\D/g,'') }}
     ~~~
     > Si tu instancia exige JID: `+ '@s.whatsapp.net'`.
   - **Mensaje**:
     ~~~twig
     {{
       $('GenerateMessage').first().json.output
         .replace('//REPLACENAME//', $json["Nombre"])
         .replace(/\*\*/g,'')
         .replace(/[\r\n]+/g,' ')
         .trim()
     }}
     ~~~
8. *(Opcional)* **Google Sheets ‚Üí Append** en `Historial` con el `Numero` enviado.

### Prompt sugerido (OpenAI)
~~~
Redacta un mensaje corto, profesional y amable para presentarle mi emprendimiento a este contacto:

Nombre: //REPLACENAME//

El emprendimiento se llama **NoEMEC (No Es Magia, Es C√≥digo)**. Ayudamos a empresas y personas con soluciones a medida en software, IoT e innovaci√≥n digital.
Incluye web: https://www.noemec.net
Tono: cercano y profesional.
Deja el nombre con la marca //REPLACENAME// para reemplazar.
~~~

> Si Evolution devuelve ‚ÄúInvalid format‚Äù, elimina Markdown y saltos de l√≠nea como en la expresi√≥n de ejemplo.

---

## 2) Flujo: **Asistente Personal** (cotiza + PDF)

### Objetivo
Recibir mensajes por WhatsApp, interpretar intenci√≥n y datos m√≠nimos de cotizaci√≥n, **confirmar**, generar un **HTML** y convertirlo a **PDF** para enviarlo por WhatsApp.

### Estructura m√≠nima de nodos
1. **Webhook (POST)** ‚Üí recibe eventos entrantes (relay desde Evolution o tu gateway).  
2. **Set** ‚Üí variables √∫tiles (`userNumber`, `userMessage`, etc.).  
3. **OpenAI (Chat/Agent)** con **System Prompt** (responde **solo JSON** con el esquema simplificado).  
4. **Code** ‚Üí `JSON.parse` del `output` ‚Üí objeto `chatGptResponse`.  
5. **IF** `chatGptResponse.email.send == true`
   - **Code** ‚Üí construir **HTML** de cotizaci√≥n (simple).
   - **HTTP Request** ‚Üí servicio **HTML‚ÜíPDF** (p.ej., Gotenberg/Chromium en local).
   - **Evolution API ‚Üí send-document** (adjunta el PDF).
6. **Else** ‚Üí **Evolution API ‚Üí send-text** con `chatGptResponse.reply`.

### System Prompt (esquema simplificado)
- M√≠nimos para confirmar: `servicio`, `alcance`, `nombre`, y **uno** entre `email` o `telefono`.  
- Normaliza `servicio` con sin√≥nimos (`web`, `apps_movil`, `analisis_datos`, `audiovisual`, `iot`, `gerencia_proyectos`).  
- Estados: `collecting ‚Üí confirming ‚Üí confirmed ‚Üí cancelled`.  
- Responde **solo JSON** v√°lido; nada de texto extra.

### Code (HTML m√≠nimo para PDF)
~~~js
const data = $json.chatGptResponse || $json;

const escape = (s='') => String(s)
 .replace(/&/g,'&amp;').replace(/</g,'&lt;')
 .replace(/>/g,'&gt;').replace(/"/g,'&quot;');

const mapServicio = (code) => ({
  apps_movil:'Desarrollo de Apps M√≥viles',
  web:'Desarrollo Web',
  analisis_datos:'An√°lisis de Datos',
  audiovisual:'Producci√≥n Audiovisual',
  iot:'Soluciones IoT',
  gerencia_proyectos:'Gerencia de Proyectos TI'
}[code] || 'Servicio');

const p = data.project || {};
const empresa  = p.empresa || '‚Äî';
const email    = p.email   || data.email?.to || '‚Äî';
const telefono = p.telefono|| '‚Äî';
const alcance  = p.alcance || 'Alcance por confirmar';
const servicio = mapServicio(p.servicio || 'web');
const precio   = (data.email && data.email.costo_estimado) ? data.email.costo_estimado : (p.presupuesto || 0);

const precioFmt = new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0}).format(Number(precio));
const fecha = new Date().toLocaleDateString('es-CO', {year:'numeric', month:'long', day:'numeric'});

const html = `<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cotizaci√≥n - ${escape(empresa)}</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;max-width:800px;margin:0 auto;padding:40px;color:#111}
h1,h2{color:#2563eb;margin:0 0 12px}
.section{border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin:16px 0;background:#fafafa}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.kv b{color:#374151}
.price{font-size:28px;font-weight:bold;color:#b45309}
.footer{margin-top:24px;color:#6b7280;text-align:center}
a{color:#2563eb;text-decoration:none}
</style>
</head><body>
<div style="text-align:right;color:#6b7280">Fecha: ${escape(fecha)}</div>
<h1>COTIZACI√ìN</h1>
<div class="section">
  <h2>Informaci√≥n del Cliente</h2>
  <div class="kv">
    <div><b>Empresa</b><br>${escape(empresa)}</div>
    <div><b>Email</b><br>${escape(email)}</div>
    <div><b>Tel√©fono</b><br>${escape(telefono)}</div>
    <div><b>Servicio</b><br>${escape(servicio)}</div>
  </div>
</div>

<div class="section">
  <h2>Detalles del Proyecto</h2>
  <p>${escape(alcance)}</p>
</div>

<div class="section" style="text-align:center">
  <h2>Inversi√≥n estimada</h2>
  <div class="price">${escape(precioFmt)}</div>
  <div>Pesos Colombianos</div>
</div>

<div class="footer">
  <strong>NOEMEC ‚Äî No es Magia, Es C√≥digo</strong><br/>
  üåê <a href="https://www.noemec.net" target="_blank">www.noemec.net</a>
</div>
</body></html>`;

return [{ json: { html } }];
~~~

> Env√≠a `json.html` a tu convertidor **HTML‚ÜíPDF** (por ejemplo, Gotenberg en `http://host.docker.internal:3000/forms/chromium/convert/html`) y adjunta el PDF desde Evolution con `send-document`.

---

## 3) Pruebas r√°pidas

- **Flujo 1**: agrega 1‚Äì2 filas de prueba (Nombre/Numero), ejecuta y verifica que lleguen mensajes.  
- **Flujo 2**: env√≠a desde WhatsApp:  
  - ‚ÄúHola, quiero una *landing page*. Mi correo es ‚Ä¶‚Äù ‚Üí si falta **alcance**, el bot debe pedirlo.  
  - ‚ÄúConfirmo‚Äù ‚Üí pasa a **confirmed**, genera PDF y lo env√≠a.

---

## 4) Notas finales

- Todo corre **en local** con Docker (n8n y Evolution API).  
- **OpenAI** se usa para redacci√≥n/JSON; minimiza prompts para abaratar.  
- Si Evolution marca `Invalid format`, env√≠a **texto plano** (sin Markdown ni saltos) y valida que el **n√∫mero** est√© en E.164 (solo d√≠gitos).
