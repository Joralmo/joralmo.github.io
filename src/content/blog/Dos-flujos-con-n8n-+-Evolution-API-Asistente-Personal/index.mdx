---
title: "Dos flujos con n8n + Evolution API en local (Docker): paso a paso bÃ¡sico"
pubDate: 2025-09-25T12:00:00
banner: ./banner.png
description: "GuÃ­a rÃ¡pida para montar en local dos flujos: PresentaciÃ³n a nuevos contactos y Asistente personal que cotiza y envÃ­a PDF. n8n y Evolution API corriendo en Docker."
tags:
  - n8n
  - whatsapp
  - automatizaciÃ³n
  - docker
  - openai
slug: "/n8n-evolution-docker-flujos-basicos"
canonicalUrl: https://www.noemec.net/blog/n8n-evolution-docker-flujos-basicos
---

# Dos flujos con n8nÂ + Evolution API en local (Docker): paso a paso bÃ¡sico

En esta guÃ­a montamos **dos flujos** con **n8n** y **Evolution API** en local (ambos con **Docker**), usando **OpenAI** para los textos:

1. **PresentaciÃ³n Nuevos Contactos**: EnvÃ­a un mensaje de presentaciÃ³n por WhatsApp a una lista de contactos.
2. **Asistente Personal**: Entiende la solicitud de un cliente, recopila datos, arma una cotizaciÃ³n y **envÃ­a un PDF** por WhatsApp.

Ambos flujos estÃ¡n diseÃ±ados para ser prÃ¡cticos y funcionales desde el primer momento. Â¡Vamos a ello! ğŸš€

## 0) PreparaciÃ³n del Entorno (local con Docker)

Antes de importar los flujos, necesitas tener tres servicios corriendo en Docker: **n8n**, **Evolution API** y un conversor de **HTML aÂ PDF**.

### n8nÂ (Docker)

Usa la imagen oficial para levantar tu instancia de n8n. Este serÃ¡ nuestro centro de automatizaciÃ³n.

```bash
docker run -d --name n8n \
  -p 5678:5678 \
  -v n8n_data:/home/node/.n8n \
  --add-host=host.docker.internal:host-gateway \
  n8nio/n8n:latest
```

Nota: `host.docker.internal` es clave para que n8n pueda comunicarse con otros contenedores Docker en tu mÃ¡quina, como el conversor de PDF.

### Evolution APIÂ (Docker)

Levanta tu instancia de Evolution API. Este serÃ¡ nuestro gateway para enviar y recibir mensajes de WhatsApp.

```bash
docker run -d --name evolution \
  -p 8080:8080 \
  -e AUTHENTICATION_API_KEY=TU_API_KEY_SECRETA \
  <tu_imagen_de_evolution_api>
```

Una vez levantado, entra a `http://localhost:8080`, escanea el QR con tu WhatsApp y guarda tu `API_KEY` y la `BASE_URL` (`http://localhost:8080`).

### GotenbergÂ (ConversorÂ HTMLÂ â†’ PDFÂ enÂ Docker)

Para que el Asistente Personal pueda generar PDFs, usaremos Gotenberg, un servicio muy potente y fÃ¡cil de desplegar.

```bash
docker run -d --name gotenberg \
  -p 3000:3000 \
  thecodingmachine/gotenberg:7
```

Este contenedor expondrÃ¡ un endpoint en el puertoÂ 3000 que n8n usarÃ¡ para convertir el HTML de la cotizaciÃ³n en un archivo PDF.

![Muestra de Gotenberg](./gotenberg.png)

### Claves y Credenciales en n8n

Dentro de tu n8nÂ (`http://localhost:5678`), ve a **Credentials** y aÃ±ade las siguientes:

- **OpenAI**: Crea una APIÂ key en la plataforma de OpenAI y aÃ±Ã¡dela como credencial.
- **Google Sheets**: Si vas a usar una hoja de cÃ¡lculo para los contactos, crea una credencialÂ OAuth2 y conÃ©ctala con tu cuenta de Google.
- **Evolution API**: Crea una credencial de tipo "Header Auth".
  - **Name**: `X-API-KEY`
  - **Value**: `TU_API_KEY_SECRETA` (la misma que usaste en el comando de Docker).

![Credenciales](./credentials.png)

## 1) Flujo: PresentaciÃ³n Nuevos Contactos

### Objetivo

Tomar una lista de contactos (Nombre, NÃºmero) de una hoja de Google Sheets, verificar que no se les haya contactado antes y enviarles un mensaje de presentaciÃ³n personalizado por WhatsApp.

![Hoja de Google Sheets](./hojaDeContactos.png)

### Estructura de NodosÂ (PasoÂ aÂ Paso)

- **Trigger (Manual o Programado)**: El flujo se inicia manualmente (Manual Trigger) o automÃ¡ticamente en un horario definido (Schedule Trigger, por ejemplo, todos los dÃ­as a lasÂ 10Â AM).
- **GenerateMessage (AIÂ Agent)**: Usamos OpenAI para crear una plantilla de mensaje. Esto permite variar el texto fÃ¡cilmente en el futuro sin tocar los otros nodos.
- **GetNewContacts (Google Sheets)**: Lee todas las filas de la hoja "Contactos", que debe tener las columnas `Nombre` y `Numero`.
- **GetNewContactsToArrayÂ (Code)**: Un nodo simple que formatea los contactos leÃ­dos en una lista limpia.
- **GetHistorial (Google Sheets)**: Lee la columna `Numero` de la hoja "Historial" para obtener una lista de todos los nÃºmeros ya contactados.
- **GetNewContactRealsÂ (Code)**: Compara la lista de nuevos contactos con el historial y devuelve solo aquellos a los que nunca se les ha enviado un mensaje.
- **LoopÂ OverÂ ItemsÂ (SplitÂ InÂ Batches)**: Procesa la lista de contactos "reales" uno por uno para enviar los mensajes de forma individual.
- **EnviarÂ textoÂ (EvolutionÂ API)**: EnvÃ­a el mensaje de WhatsApp.
  - **RemoteJid**: `{{ String($json.number).replace(/\D/g, '') }}` (limpia el nÃºmero para dejar solo dÃ­gitos).
  - **MessageÂ Text**: `{{ $('GenerateMessage').first().json.output.replace('//REPLACENAME//', $json["name"]) }}` (toma la plantilla de OpenAI y reemplaza `//REPLACENAME//` con el nombre del contacto).
- **SaveNumberOnHistorialÂ (Google Sheets)**: Una vez que el mensaje se envÃ­a correctamente, este nodo aÃ±ade el nÃºmero del contacto a la hoja "Historial" para no volver a contactarlo.

### Prompt para OpenAIÂ (NodoÂ "GenerateMessage")

Este es el prompt que genera la plantilla del mensaje. Es claro y le da al modelo todo el contexto necesario.

> Redacta un mensaje corto, profesional y amable para presentarle mi emprendimiento a este contacto:
>
> **Nombre**: `//REPLACENAME//`
>
> El emprendimiento se llama **NoEMECÂ (NoÂ EsÂ Magia,Â EsÂ CÃ³digo)**, y ayuda a empresas y personas a resolver retos tecnolÃ³gicos creando soluciones a medida con software, IoTÂ e innovaciÃ³n digital.
>
> Hazlo en tono cercano pero profesional, como si lo escribiera una persona.
>
> **DueÃ±oÂ delÂ emprendimiento**: JoseÂ Altamar  
> **CorreoÂ delÂ dueÃ±o**: joralmopro@gmail.com  
> **NroÂ deÂ telefonoÂ delÂ dueÃ±o**: +573002892012  
> **nuestraÂ pÃ¡ginaÂ web**: [https://www.noemec.net/](https://www.noemec.net/)
>
> Reglas:
>
> - Solamente deja para reemplazar el nombre

Al final el flujo deberÃ­a verse asÃ­:

![Flujo PresentaciÃ³n](./flujoPresentacion.png)

## 2) Flujo: Asistente PersonalÂ (CotizaÂ +Â PDF)

### Objetivo

Recibir mensajes por WhatsApp, mantener una conversaciÃ³n para recopilar los datos mÃ­nimos de una cotizaciÃ³n (servicio, alcance, nombre, contacto), pedir confirmaciÃ³n y, finalmente, generar un PDF con la cotizaciÃ³n y enviarlo por WhatsApp.

![Muestra del flujo completo](./muestraDelFlujo.png)

### ConfiguraciÃ³n del Webhook

1. En n8n, copia la URL del **Webhook** de producciÃ³n del nodo **NewMessage**.
2. En tu instancia de EvolutionÂ API, configura el **Global Webhook URL** para que apunte a la URL de n8n que copiaste.
3. Activa los eventos que quieres recibir, como `APPLICATION_STARTUP`, `QRCODE_UPDATED` y, el mÃ¡s importante, `MESSAGES_UPSERT`.

Ahora, cada mensaje que llegue a tu nÃºmero de WhatsApp serÃ¡ reenviado a n8n.

### Estructura de NodosÂ (PasoÂ aÂ Paso)

- **NewMessageÂ (Webhook)**: Recibe los datos de los mensajes entrantes desde EvolutionÂ API.
- **SetVariablesFromWhatsappÂ (Set)**: Extrae y nombra variables clave del mensaje recibido, como `userNumber`, `userName` y `userMessage`.
- **AIÂ Agent**: Este es el cerebro del flujo. Usa un modelo de OpenAI (como GPTâ€‘4oÂ Mini) con un SystemÂ Prompt muy detallado. Su Ãºnica tarea es recibir el mensaje del usuario y devolver un JSON estructurado. Nunca responde con texto libre.
- **ExtractDataÂ (Code)**: El output del AIÂ Agent es un string de texto JSON. Este nodo lo parsea (`JSON.parse`) para convertirlo en un objeto con el que n8n pueda trabajar.
- **Â¿EnviarPdf?Â (IF)**: Revisa el campo `chatGptResponse.email.send`.
  - Si es `true`, significa que la cotizaciÃ³n fue confirmada y el flujo debe generar y enviar el PDF.
  - Si es `false`, el flujo simplemente envÃ­a la respuesta de texto generada por la IA.

#### RutaÂ "True"Â (Generar PDF)

- **CreateHtmlÂ (Code)**: Usa el objeto `chatGptResponse` para construir dinÃ¡micamente un documento HTML con todos los detalles de la cotizaciÃ³n.
- **ConvertToHtmlFile**: Convierte el string HTML en un archivo binario que el siguiente nodo pueda procesar.
- **HtmlToPdfÂ (HTTPÂ Request)**: EnvÃ­a el archivo HTML al servicio de Gotenberg (`http://host.docker.internal:3000/forms/chromium/convert/html`) y recibe a cambio un archivo PDF binario.
- **DocumentToBase64**: Convierte el PDF binario a formato Base64, que es el que necesita el nodo de EvolutionÂ API.
- **EnviarÂ documentoÂ (EvolutionÂ API)**: EnvÃ­a el PDF al usuario a travÃ©s de WhatsApp.

#### RutaÂ "False"Â (Enviar Texto)

- **EnviarÂ textoÂ (EvolutionÂ API)**: EnvÃ­a la respuesta conversacional (`chatGptResponse.reply`) al usuario. Por ejemplo: "Â¿PodrÃ­as darme mÃ¡s detalles sobre el alcance del proyecto?".

### System Prompt ClaveÂ (NodoÂ "AIÂ Agent")

Este prompt es la regla fundamental que define todo el comportamiento del asistente. Le dice a la IA cÃ³mo pensar, quÃ© datos necesita y, lo mÃ¡s importante, que solo debe responder con un JSON vÃ¡lido.

```json
{
  "reply": "texto breve para el cliente",
  "intent": "cotizacion|informacion|saludo|desconocido",
  "status": "collecting|confirming|confirmed|cancelled",
  "missing": ["servicio","alcance","nombre","email|telefono"],
  "project": {
    "servicio": "apps_movil|web|analisis_datos|audiovisual|iot|gerencia_proyectos",
    "alcance": "",
    "nombre": "",
    "email": "",
    "telefono": "",
    "presupuesto": 0,
    "empresa": "",
    "notas": ""
  },
  "email": {
    "send": false,
    "to": "",
    "subject": "",
    "html": "",
    "costo_estimado": "AcÃ¡ la respuesta es un nÃºmero calculado de acuerdo al servicio y alcance",
    "justificacion": "AcÃ¡ va una breve justificaciÃ³n del costo, basada en el alcance que te dio el cliente sin mencionar cuanto cobro por hora o jornada"
  }
}
```

---

### Reglas y conocimientos sobreÂ NoEMEC:

- **Fundador**: JosÃ©Â RafaelÂ AltamarÂ MolinaÂ (JoralmoPro), programador full stack y emprendedor.
- **Slogan**: "No es Magia, Es CÃ³digo".
- **PÃ¡gina web oficial**: [https://www.noemec.net](https://www.noemec.net)
- **UbicaciÃ³n**: Colombia, con proyecciÃ³n nacional e internacional.
- **Costo por jornada**: 120â€¯000Â COP (8Â horas).
- Si un proyecto (ejemplo pÃ¡gina web bÃ¡sica) tomaÂ 5Â jornadas, el costo estimado es 600â€¯000Â COP +Â IVA +Â 30â€¯% de imprevistos.

**Servicios principales:**

- Desarrollo de AppsÂ MÃ³viles (`apps_movil`)
- DesarrolloÂ Web (`web`)
- AnÃ¡lisis de Datos (`analisis_datos`)
- ProducciÃ³n Audiovisual (`audiovisual`)
- SolucionesÂ IoT (`iot`)
- Gerencia de ProyectosÂ TI (`gerencia_proyectos`)

**Mapa de sinÃ³nimosÂ â†’Â cÃ³digo interno (aplica siempre):**

- `apps_movil`: app, aplicaciÃ³n, mÃ³vil, android, ios, playÂ store, app informativa, rifas, sorteo
- `web`: pÃ¡gina web, sitio web, landing, landingÂ page
- `analisis_datos`: datos, BI, dashboard, reportes, powerÂ bi, analytics
- `audiovisual`: video, filmaciÃ³n, grabaciÃ³n, ediciÃ³n, boda, evento, comercial
- `iot`: sensores, arduino, raspberry, domÃ³tica, automatizaciÃ³n
- `gerencia_proyectos`: PM, gestiÃ³n de proyecto, scrum, pmo

---

### ğŸ“Œ SimplificaciÃ³n del proceso de cotizaciÃ³n

**Campos mÃ­nimos requeridos (`missing`):**

- `servicio`
- `alcance`
- `nombre`
- al menos **uno**: `email` o `telefono`

---

### ğŸ“‹ Flujo de estados

1. **collecting**: Pide solo el siguiente campo faltante de los 4Â mÃ­nimos.
2. **confirming**: Solo pasa a `confirming` cuando `missing.length === 0`. Presenta un resumen y pide confirmaciÃ³n.
3. **confirmed**: Si el usuario confirma, pasa a `confirmed`, responde con un agradecimiento breve y arma el correo (`email.send=true`).
4. **cancelled**: Si el usuario dice "cancelar", responde amable y deja `status="cancelled"`.

## 3) Pruebas RÃ¡pidas

**FlujoÂ 1Â (PresentaciÃ³n):** AÃ±ade tu propio nÃºmero y nombre a la hoja de GoogleÂ Sheets. Ejecuta el flujo manualmente y verifica que recibes el mensaje de presentaciÃ³n en tu WhatsApp.

**FlujoÂ 2Â (Asistente):** EnvÃ­a mensajes desde otro nÃºmero de WhatsApp al nÃºmero conectado a EvolutionÂ API.

- **PruebaÂ 1:** "Hola, quiero una pÃ¡gina web". El bot deberÃ­a responder pidiendo mÃ¡s detalles (el alcance).
- **PruebaÂ 2:** "Es para una landing page sencilla, mi nombre es Carlos y mi correo es test@test.com". El bot deberÃ­a presentar un resumen y pedir confirmaciÃ³n.
- **PruebaÂ 3:** "Confirmo". El bot deberÃ­a responder con un agradecimiento y enviarte el PDF de la cotizaciÃ³n.

## 4) Notas Finales

Estos flujos demuestran cÃ³mo puedes crear automatizaciones complejas y Ãºtiles con herramientas que corren completamente en tu entorno local (excepto las APIs de OpenAI y Google).

El **SystemÂ Prompt** es el componente mÃ¡s importante del asistente. AjÃºstalo para refinar su comportamiento, aÃ±adir nuevos servicios o cambiar las reglas de negocio.

Si EvolutionÂ API devuelve errores de "Invalid format", asegÃºrate de que el nÃºmero de telÃ©fono estÃ© limpio (solo dÃ­gitos, sin `+` ni espacios) y que el texto no contenga formatos extraÃ±os de Markdown que WhatsApp no soporte.

Â¡Espero que esta guÃ­a te sea de gran utilidad para empezar a automatizar tus conversaciones de WhatsApp con n8n!

## 5) Disclaimer

Este tutorial es una guÃ­a bÃ¡sica para montar flujos con n8n y Evolution API en local. No cubre aspectos avanzados como seguridad, escalabilidad o manejo de errores en profundidad. Ãšsalo como punto de partida y adapta los flujos a tus necesidades especÃ­ficas, ademÃ¡s siempre es mejor usar la API de WhatsApp oficial para proyectos en producciÃ³n.

> Nos vemos en lÃ­nea.