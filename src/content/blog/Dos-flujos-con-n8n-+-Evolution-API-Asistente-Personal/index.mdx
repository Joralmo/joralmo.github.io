---
title: "Dos flujos con n8n + Evolution API en local (Docker): paso a paso b√°sico"
pubDate: 2025-09-25T12:00:00
banner: ./banner.png
description: "Gu√≠a r√°pida para montar en local dos flujos: Presentaci√≥n a nuevos contactos y Asistente personal que cotiza y env√≠a PDF. n8n y Evolution API corriendo en Docker."
tags:
  - n8n
  - whatsapp
  - automatizaci√≥n
  - docker
  - openai
slug: "/n8n-evolution-docker-flujos-basicos"
canonicalUrl: https://www.noemec.net/blog/n8n-evolution-docker-flujos-basicos
---

# Dos flujos con n8n¬†+ Evolution API en local (Docker): paso a paso b√°sico

En esta gu√≠a montamos **dos flujos** con **n8n** y **Evolution API** en local (ambos con **Docker**), usando **OpenAI** para los textos:

1. **Presentaci√≥n Nuevos Contactos**: Env√≠a un mensaje de presentaci√≥n por WhatsApp a una lista de contactos.
2. **Asistente Personal**: Entiende la solicitud de un cliente, recopila datos, arma una cotizaci√≥n y **env√≠a un PDF** por WhatsApp.

Ambos flujos est√°n dise√±ados para ser pr√°cticos y funcionales desde el primer momento. ¬°Vamos a ello! üöÄ

## 0) Preparaci√≥n del Entorno (local con Docker)

Antes de importar los flujos, necesitas tener tres servicios corriendo en Docker: **n8n**, **Evolution API** y un conversor de **HTML a¬†PDF**.

### n8n¬†(Docker)

Usa la imagen oficial para levantar tu instancia de n8n. Este ser√° nuestro centro de automatizaci√≥n.

```bash
docker run -d --name n8n \
  -p 5678:5678 \
  -v n8n_data:/home/node/.n8n \
  --add-host=host.docker.internal:host-gateway \
  n8nio/n8n:latest
```

Nota: `host.docker.internal` es clave para que n8n pueda comunicarse con otros contenedores Docker en tu m√°quina, como el conversor de PDF.

### Evolution API¬†(Docker)

Levanta tu instancia de Evolution API. Este ser√° nuestro gateway para enviar y recibir mensajes de WhatsApp.

```bash
docker run -d --name evolution \
  -p 8080:8080 \
  -e AUTHENTICATION_API_KEY=TU_API_KEY_SECRETA \
  <tu_imagen_de_evolution_api>
```

Una vez levantado, entra a `http://localhost:8080`, escanea el QR con tu WhatsApp y guarda tu `API_KEY` y la `BASE_URL` (`http://localhost:8080`).

### Gotenberg¬†(Conversor¬†HTML¬†‚Üí PDF¬†en¬†Docker)

Para que el Asistente Personal pueda generar PDFs, usaremos Gotenberg, un servicio muy potente y f√°cil de desplegar.

```bash
docker run -d --name gotenberg \
  -p 3000:3000 \
  thecodingmachine/gotenberg:7
```

Este contenedor expondr√° un endpoint en el puerto¬†3000 que n8n usar√° para convertir el HTML de la cotizaci√≥n en un archivo PDF.

![Muestra de Gotenberg](./gotenberg.png)

### Claves y Credenciales en n8n

Dentro de tu n8n¬†(`http://localhost:5678`), ve a **Credentials** y a√±ade las siguientes:

- **OpenAI**: Crea una API¬†key en la plataforma de OpenAI y a√±√°dela como credencial.
- **Google Sheets**: Si vas a usar una hoja de c√°lculo para los contactos, crea una credencial¬†OAuth2 y con√©ctala con tu cuenta de Google.
- **Evolution API**: Crea una credencial de tipo "Header Auth".
  - **Name**: `X-API-KEY`
  - **Value**: `TU_API_KEY_SECRETA` (la misma que usaste en el comando de Docker).

![Credenciales](./credentials.png)

## 1) Flujo: Presentaci√≥n Nuevos Contactos

### Objetivo

Tomar una lista de contactos (Nombre, N√∫mero) de una hoja de Google Sheets, verificar que no se les haya contactado antes y enviarles un mensaje de presentaci√≥n personalizado por WhatsApp.

![Hoja de Google Sheets](./hojaDeContactos.png)

### Estructura de Nodos¬†(Paso¬†a¬†Paso)

- **Trigger (Manual o Programado)**: El flujo se inicia manualmente (Manual Trigger) o autom√°ticamente en un horario definido (Schedule Trigger, por ejemplo, todos los d√≠as a las¬†10¬†AM).
- **GenerateMessage (AI¬†Agent)**: Usamos OpenAI para crear una plantilla de mensaje. Esto permite variar el texto f√°cilmente en el futuro sin tocar los otros nodos.
- **GetNewContacts (Google Sheets)**: Lee todas las filas de la hoja "Contactos", que debe tener las columnas `Nombre` y `Numero`.
- **GetNewContactsToArray¬†(Code)**: Un nodo simple que formatea los contactos le√≠dos en una lista limpia.
- **GetHistorial (Google Sheets)**: Lee la columna `Numero` de la hoja "Historial" para obtener una lista de todos los n√∫meros ya contactados.
- **GetNewContactReals¬†(Code)**: Compara la lista de nuevos contactos con el historial y devuelve solo aquellos a los que nunca se les ha enviado un mensaje.
- **Loop¬†Over¬†Items¬†(Split¬†In¬†Batches)**: Procesa la lista de contactos "reales" uno por uno para enviar los mensajes de forma individual.
- **Enviar¬†texto¬†(Evolution¬†API)**: Env√≠a el mensaje de WhatsApp.
  - **RemoteJid**: `{{ String($json.number).replace(/\D/g, '') }}` (limpia el n√∫mero para dejar solo d√≠gitos).
  - **Message¬†Text**: `{{ $('GenerateMessage').first().json.output.replace('//REPLACENAME//', $json["name"]) }}` (toma la plantilla de OpenAI y reemplaza `//REPLACENAME//` con el nombre del contacto).
- **SaveNumberOnHistorial¬†(Google Sheets)**: Una vez que el mensaje se env√≠a correctamente, este nodo a√±ade el n√∫mero del contacto a la hoja "Historial" para no volver a contactarlo.

### Prompt para OpenAI¬†(Nodo¬†"GenerateMessage")

Este es el prompt que genera la plantilla del mensaje. Es claro y le da al modelo todo el contexto necesario.

> Redacta un mensaje corto, profesional y amable para presentarle mi emprendimiento a este contacto:
>
> **Nombre**: `//REPLACENAME//`
>
> El emprendimiento se llama **NoEMEC¬†(No¬†Es¬†Magia,¬†Es¬†C√≥digo)**, y ayuda a empresas y personas a resolver retos tecnol√≥gicos creando soluciones a medida con software, IoT¬†e innovaci√≥n digital.
>
> Hazlo en tono cercano pero profesional, como si lo escribiera una persona.
>
> **Due√±o¬†del¬†emprendimiento**: Jose¬†Altamar  
> **Correo¬†del¬†due√±o**: joralmopro@gmail.com  
> **Nro¬†de¬†telefono¬†del¬†due√±o**: +573002892012  
> **nuestra¬†p√°gina¬†web**: [https://www.noemec.net/](https://www.noemec.net/)
>
> Reglas:
>
> - Solamente deja para reemplazar el nombre

Al final el flujo deber√≠a verse as√≠:

![Flujo Presentaci√≥n](./flujoPresentacion.png)

## 2) Flujo: Asistente Personal¬†(Cotiza¬†+¬†PDF)

### Objetivo

Recibir mensajes por WhatsApp, mantener una conversaci√≥n para recopilar los datos m√≠nimos de una cotizaci√≥n (servicio, alcance, nombre, contacto), pedir confirmaci√≥n y, finalmente, generar un PDF con la cotizaci√≥n y enviarlo por WhatsApp.

![Muestra del flujo completo](./muestraDelFlujo.png)

### Configuraci√≥n del Webhook

1. En n8n, copia la URL del **Webhook** de producci√≥n del nodo **NewMessage**.
2. En tu instancia de Evolution¬†API, configura el **Global Webhook URL** para que apunte a la URL de n8n que copiaste.
3. Activa los eventos que quieres recibir, como `APPLICATION_STARTUP`, `QRCODE_UPDATED` y, el m√°s importante, `MESSAGES_UPSERT`.

Ahora, cada mensaje que llegue a tu n√∫mero de WhatsApp ser√° reenviado a n8n.

### Estructura de Nodos¬†(Paso¬†a¬†Paso)

- **NewMessage¬†(Webhook)**: Recibe los datos de los mensajes entrantes desde Evolution¬†API.
- **SetVariablesFromWhatsapp¬†(Set)**: Extrae y nombra variables clave del mensaje recibido, como `userNumber`, `userName` y `userMessage`.
- **AI¬†Agent**: Este es el cerebro del flujo. Usa un modelo de OpenAI (como GPT‚Äë4o¬†Mini) con un System¬†Prompt muy detallado. Su √∫nica tarea es recibir el mensaje del usuario y devolver un JSON estructurado. Nunca responde con texto libre.
- **ExtractData¬†(Code)**: El output del AI¬†Agent es un string de texto JSON. Este nodo lo parsea (`JSON.parse`) para convertirlo en un objeto con el que n8n pueda trabajar.
- **¬øEnviarPdf?¬†(IF)**: Revisa el campo `chatGptResponse.email.send`.
  - Si es `true`, significa que la cotizaci√≥n fue confirmada y el flujo debe generar y enviar el PDF.
  - Si es `false`, el flujo simplemente env√≠a la respuesta de texto generada por la IA.

#### Ruta¬†"True"¬†(Generar PDF)

- **CreateHtml¬†(Code)**: Usa el objeto `chatGptResponse` para construir din√°micamente un documento HTML con todos los detalles de la cotizaci√≥n.
- **ConvertToHtmlFile**: Convierte el string HTML en un archivo binario que el siguiente nodo pueda procesar.
- **HtmlToPdf¬†(HTTP¬†Request)**: Env√≠a el archivo HTML al servicio de Gotenberg (`http://host.docker.internal:3000/forms/chromium/convert/html`) y recibe a cambio un archivo PDF binario.
- **DocumentToBase64**: Convierte el PDF binario a formato Base64, que es el que necesita el nodo de Evolution¬†API.
- **Enviar¬†documento¬†(Evolution¬†API)**: Env√≠a el PDF al usuario a trav√©s de WhatsApp.

#### Ruta¬†"False"¬†(Enviar Texto)

- **Enviar¬†texto¬†(Evolution¬†API)**: Env√≠a la respuesta conversacional (`chatGptResponse.reply`) al usuario. Por ejemplo: "¬øPodr√≠as darme m√°s detalles sobre el alcance del proyecto?".

### System Prompt Clave¬†(Nodo¬†"AI¬†Agent")

Este prompt es la regla fundamental que define todo el comportamiento del asistente. Le dice a la IA c√≥mo pensar, qu√© datos necesita y, lo m√°s importante, que solo debe responder con un JSON v√°lido.

```json
{
  "reply": "texto breve para el cliente",
  "intent": "cotizacion|informacion|saludo|desconocido",
  "status": "collecting|confirming|confirmed|cancelled",
  "missing": ["servicio","alcance","nombre","email|telefono"],
  "project": {
    "servicio": "apps_movil|web|analisis_datos|audiovisual|iot|gerencia_proyectos",
    "alcance": "",
    "nombre": "",
    "email": "",
    "telefono": "",
    "presupuesto": 0,
    "empresa": "",
    "notas": ""
  },
  "email": {
    "send": false,
    "to": "",
    "subject": "",
    "html": "",
    "costo_estimado": "Ac√° la respuesta es un n√∫mero calculado de acuerdo al servicio y alcance",
    "justificacion": "Ac√° va una breve justificaci√≥n del costo, basada en el alcance que te dio el cliente sin mencionar cuanto cobro por hora o jornada"
  }
}
```

---

### Reglas y conocimientos sobre¬†NoEMEC:

- **Fundador**: Jos√©¬†Rafael¬†Altamar¬†Molina¬†(JoralmoPro), programador full stack y emprendedor.
- **Slogan**: "No es Magia, Es C√≥digo".
- **P√°gina web oficial**: [https://www.noemec.net](https://www.noemec.net)
- **Ubicaci√≥n**: Colombia, con proyecci√≥n nacional e internacional.
- **Costo por jornada**: 120‚ÄØ000¬†COP (8¬†horas).
- Si un proyecto (ejemplo p√°gina web b√°sica) toma¬†5¬†jornadas, el costo estimado es 600‚ÄØ000¬†COP +¬†IVA +¬†30‚ÄØ% de imprevistos.

**Servicios principales:**

- Desarrollo de Apps¬†M√≥viles (`apps_movil`)
- Desarrollo¬†Web (`web`)
- An√°lisis de Datos (`analisis_datos`)
- Producci√≥n Audiovisual (`audiovisual`)
- Soluciones¬†IoT (`iot`)
- Gerencia de Proyectos¬†TI (`gerencia_proyectos`)

**Mapa de sin√≥nimos¬†‚Üí¬†c√≥digo interno (aplica siempre):**

- `apps_movil`: app, aplicaci√≥n, m√≥vil, android, ios, play¬†store, app informativa, rifas, sorteo
- `web`: p√°gina web, sitio web, landing, landing¬†page
- `analisis_datos`: datos, BI, dashboard, reportes, power¬†bi, analytics
- `audiovisual`: video, filmaci√≥n, grabaci√≥n, edici√≥n, boda, evento, comercial
- `iot`: sensores, arduino, raspberry, dom√≥tica, automatizaci√≥n
- `gerencia_proyectos`: PM, gesti√≥n de proyecto, scrum, pmo

---

### üìå Simplificaci√≥n del proceso de cotizaci√≥n

**Campos m√≠nimos requeridos (`missing`):**

- `servicio`
- `alcance`
- `nombre`
- al menos **uno**: `email` o `telefono`

---

### üìã Flujo de estados

1. **collecting**: Pide solo el siguiente campo faltante de los 4¬†m√≠nimos.
2. **confirming**: Solo pasa a `confirming` cuando `missing.length === 0`. Presenta un resumen y pide confirmaci√≥n.
3. **confirmed**: Si el usuario confirma, pasa a `confirmed`, responde con un agradecimiento breve y arma el correo (`email.send=true`).
4. **cancelled**: Si el usuario dice "cancelar", responde amable y deja `status="cancelled"`.

## 3) Pruebas R√°pidas

**Flujo¬†1¬†(Presentaci√≥n):** A√±ade tu propio n√∫mero y nombre a la hoja de Google¬†Sheets. Ejecuta el flujo manualmente y verifica que recibes el mensaje de presentaci√≥n en tu WhatsApp.

**Flujo¬†2¬†(Asistente):** Env√≠a mensajes desde otro n√∫mero de WhatsApp al n√∫mero conectado a Evolution¬†API.

- **Prueba¬†1:** "Hola, quiero una p√°gina web". El bot deber√≠a responder pidiendo m√°s detalles (el alcance).
- **Prueba¬†2:** "Es para una landing page sencilla, mi nombre es Carlos y mi correo es test@test.com". El bot deber√≠a presentar un resumen y pedir confirmaci√≥n.
- **Prueba¬†3:** "Confirmo". El bot deber√≠a responder con un agradecimiento y enviarte el PDF de la cotizaci√≥n.

## 4) Notas Finales

Estos flujos demuestran c√≥mo puedes crear automatizaciones complejas y √∫tiles con herramientas que corren completamente en tu entorno local (excepto las APIs de OpenAI y Google).

El **System¬†Prompt** es el componente m√°s importante del asistente. Aj√∫stalo para refinar su comportamiento, a√±adir nuevos servicios o cambiar las reglas de negocio.

Si Evolution¬†API devuelve errores de "Invalid format", aseg√∫rate de que el n√∫mero de tel√©fono est√© limpio (solo d√≠gitos, sin `+` ni espacios) y que el texto no contenga formatos extra√±os de Markdown que WhatsApp no soporte.

¬°Espero que esta gu√≠a te sea de gran utilidad para empezar a automatizar tus conversaciones de WhatsApp con n8n!

## 5) Disclaimer

Este tutorial es una gu√≠a b√°sica para montar flujos con n8n y Evolution API en local. No cubre aspectos avanzados como seguridad, escalabilidad o manejo de errores en profundidad. √ösalo como punto de partida y adapta los flujos a tus necesidades espec√≠ficas, adem√°s siempre es mejor usar la API de WhatsApp oficial para proyectos en producci√≥n.

> Nos vemos en l√≠nea.