---
title: Desplegar api Go (Fiber) en Railway autom치ticamente con GitLab
date: 2022-09-26 10:00:00
description: Como desplegar una api en Go (Fiber) en Railway autom치ticamente con GitLab, para que cada vez que hagamos un push a la rama main se despliegue autom치ticamente.
banner: ./banner.png
tags:
- Go
- Fiber
- GitLab
- Railway
- tutorial
- programaci칩n
slug: "/deploy-go-api-fiber-railway-gitlab"
canonicalUrl: https://blog.joralmo.pro/deploy-go-api-fiber-railway-gitlab
---

#### Holaaa 游녦 aqu칤 vamos de nuevo con un tutorial, donde veremos como desplegar un proyecto de Go con Fiber en Railway por medio del CI/CD de Gitlab, ya que cuando intent칠 hacerlo la documentaci칩n al respecto es poca, as칤 que aqu칤 vamos a ver como hacerlo paso a paso, pero primero:

쯈u칠 es <a href="https://gitlab.com/" target="_blank">GitLab</a>? 游뱂
Gitlab es una plataforma de desarrollo colaborativo para alojar repositorios de c칩digo, gestionar proyectos y controlar la actividad de los desarrolladores, 
muy similar a GitHub pero con algunas diferencias, tambi칠n es gratis y tiene en su plan gratis el servicio de CI/CD que nos permite ejecutar acciones a partir
de un push a un repositorio, como por ejemplo desplegar una aplicaci칩n en un servidor.<br/><br/>
쯈u칠 es <a href="https://railway.app/" target="_blank">Railway</a>? 游뱂
Railway es una plataforma de hosting para desplegar aplicaciones web, es gratuita y tiene un plan de pago, en el plan gratuito podemos desplegar una aplicaci칩n autom치ticamente al configurar un token que usaremos desde gitlab para desplegar la aplicaci칩n, tambi칠n podemos desplegar una aplicaci칩n manualmente, pero en este tutorial veremos como desplegarla autom치ticamente.

#### Empecemos 游

Para este tutorial he preparado este peque침o proyecto en Go con Fiber, una peque침a api con dos enpoints, uno para ver que est치 funcionando y otro protegido por una api-key (esto para ver como configurar variables de entorno en railway) y que nos devuelve un array de string a modo de ejemplo, puedes clonar el proyecto desde <a href="https://gitlab.com/JoralmoPro/gotorailwaytutorial" target="_blank">aqu칤</a>.

```go:title=api-code
package main

import (
	"os"

	"github.com/fiberweb/apikey/v2"
	"github.com/gofiber/fiber/v2"
)

func main() {

	app := fiber.New()

	app.Get("/", func(c *fiber.Ctx) error {
		return c.SendString("춰Api It's working!")
	})

	app.Use(apikey.New(apikey.Config{Key: os.Getenv("API_KEY")}))

	app.Get("/services", func(c *fiber.Ctx) error {
		services := []string{"service1", "service2", "service3"}
		return c.JSON(services)
	})

	port := os.Getenv("PORT")

	if port == "" {
		port = "3000"
	}

	app.Listen(":" + port)

}
```

#### Configuraci칩n de Railway 游

Seguidamente procedemos con railway para la configuraci칩n del proyecto y del servicio desde su dashboard, railway permite desplegar aplicaciones incluso sin estar logeados
pero para este caso necesitamos estar logeados para generar un token que es el que utilizaremos para enviar el proyecto desde el CI/CD de gitlab, para esto, una vez ingresamos a la p치gina de railway y nos logeamos,
vamos a crear un nuevo proyecto:
![Inicio railway](./start_railway.png)
Seguidamente elegimos la opci칩n para crear un proyecto vac칤o:
![Crear proyecto](./empty_project.png)
Una vez nuestro proyecto se ha creado, procedemos a agregar un nuevo servicio vac칤o:
![Agregar servicio](./created_project.png)
![Nuevo servicio](./new_service.png)
![Servicio vac칤o](./empty_service.png)
![Servicio creado](./service_created.png)
Al hacer click sobre el servicio creado lo podremos editar, y vamos a colocarle un nombre mas amigable 游때
![Editar servicio](./change_service_name.png)
Ahora en la esquina superior derecha en los settings del proyecto vamos a generar un token para poder desplegar la aplicaci칩n desde el CI/CD de gitlab:
### Importante copiarlo apenas sea generado ya que solo se puede ver una vez
![Token](./gitlab_token.png)
Y de momento por parte de railway ya tenemos todo listo para desplegar la aplicaci칩n, ahora vamos a configurar el CI/CD de gitlab.

#### Configuraci칩n de GitLab 游
En las configuraciones de nuestro repositorio, en el apartado de CI/CD vamos a agregar una variable de entorno llamada RAILWAY_TOKEN y RAILWAY_SERVICE_NAME donde pegamos el token que generamos en railway y el nombre de nuestro servicio:
![Configuraci칩n CI/CD](./conf_cicd.png)
![Token y service name](./variable_configuration_gitlab.png)
![Variables](./variables_added.png)
Y ahora procedemos a crear el archivo .gitlab-ci.yml en nuestro repositorio con el siguiente contenido:
```yml:title=.gitlab-ci.yml
stages:
  - deploy

deploy-railway:
  stage: deploy
  image: ubuntu
  only:
    - pushes
    - main
  script:
    - apt-get update && apt-get install -y curl
    - curl -fsSL https://railway.app/install.sh | sh
    - railway up --service=$RAILWAY_SERVICE_NAME -d
```
Railway por defecto busca la variable de entorno RAILWAY_TOKEN para autenticarse, por lo que no es necesario agregarla en el archivo .gitlab-ci.yml, ahora solo nos queda hacer un push a nuestro repositorio y ver como se despliega la aplicaci칩n autom치ticamente en railway.
Ahora una vez a침adido el archivo y luego de hacer push, podemos ver en la secci칩n de CI/CD de gitlab como empieza a ejecutarse el pipeline:
![Pipeline](./pipeline.png)
![Pipeline](./pipeline2.png)
![Pipeline](./pipeline_railway_details.png)

Y en railway podemos ver el servicio ya desplegado, pero al ser la primera vez y como es un servicio web nuevo, nos sugerir치 que agreguemos una url para poder acceder a la aplicaci칩n, de momento elegiremos generar un dominio:
![Railway](./deploy_in_railway.png)
Una vez generado nos lo muestra y desde ah칤 mismo podremos acceder a nuestra aplicaci칩n:
![Railway](./domain_generated.png)
Damos click para navegar al dominio:
![Railway](./visit_domain.png)
Probamos desde postman el endpoint de /services sin el token, podemos ver que retorna un error de autorizaci칩n:
![Postman](./test_postman_without_token.png)
Para configurar el API_KEY volvemos a railway y hacemos click sobre el servicio y vamos a la secci칩n de variables y creamos una nueva:
![Railway](./create_api_key.png)
Probamos nuevamente desde postman pero ahora si enviando el header x-api-key con el valor de la variable de entorno API_KEY y vemos que nos responde sin problemas:
![Postman](./test_postman_with_token.png)

Y con esto ya tendr칤amos nuestra api de Go desplegada en Railway y con un CI/CD automatizado desde GitLab, espero que les haya gustado el tutorial y que les sirva para sus proyectos, cualquier duda o comentario me pueden encontrar en las redes como @JoralmoPro.

> Nos vemos en l칤nea.
